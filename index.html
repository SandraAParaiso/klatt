<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintetizador de Formantes Klatt - Implementaci√≥n Fiel al Paper Original</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .synthesis-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .control-group:hover {
            transform: translateY(-3px);
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            appearance: none;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .play-controls {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .play-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            font-weight: 600;
        }

        .play-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.6);
        }

        .play-button.stop {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .play-button.download {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.4);
        }

        .vowel-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .vowel-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
            min-width: 80px;
        }

        .vowel-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .spectrum-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .spectrum-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
        }

        #spectrum {
            width: 100%;
            height: 250px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
        }

        .info-section {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #2196f3;
        }

        .info-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .info-section p {
            line-height: 1.6;
            color: #424242;
            margin-bottom: 10px;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .vowel-chart {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .vowel-space {
            width: 300px;
            height: 200px;
            border: 2px solid #ddd;
            margin: 0 auto;
            position: relative;
            background: linear-gradient(45deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 10px;
        }

        .vowel-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .vowel-point:hover {
            transform: scale(1.3);
        }

        .vowel-point.a { background: #ff4757; }
        .vowel-point.e { background: #3742fa; }
        .vowel-point.i { background: #2ed573; }
        .vowel-point.o { background: #ffa502; }
        .vowel-point.u { background: #5f27cd; }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .vowel-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }

            .play-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sintetizador de Formantes Klatt</h1>
            <p>Implementaci√≥n fiel al paper original "Software for a cascade/parallel formant synthesizer" (1980)</p>
        </div>
        
        <div class="main-content">
            <div id="status-message" class="status-message" style="display: none;"></div>
            
            <div class="synthesis-tabs">
                <button class="tab-button active" onclick="switchTab('vowels')">S√≠ntesis de Vocales</button>
                <button class="tab-button" onclick="switchTab('general')">S√≠ntesis General</button>
            </div>

            <!-- Tab de Vocales -->
            <div id="vowels-tab" class="tab-content active">
                <div class="vowel-chart">
                    <h3 style="text-align: center; margin-bottom: 20px;">Espacio Voc√°lico Espa√±ol (F1 vs F2)</h3>
                    <div class="vowel-space" id="vowel-space">
                        <!-- Los puntos voc√°licos se generar√°n din√°micamente -->
                    </div>
                    <p style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #666;">
                        Haz clic en las vocales o ajusta los formantes manualmente
                    </p>
                </div>

                <div class="vowel-buttons">
                    <button class="vowel-button" onclick="setVowel('a')">/a/</button>
                    <button class="vowel-button" onclick="setVowel('e')">/e/</button>
                    <button class="vowel-button" onclick="setVowel('i')">/i/</button>
                    <button class="vowel-button" onclick="setVowel('o')">/o/</button>
                    <button class="vowel-button" onclick="setVowel('u')">/u/</button>
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Fuente Glotal</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F0 - Frecuencia Fundamental (Hz)</span>
                                <span id="f0-value">120</span>
                            </div>
                            <input type="range" id="f0-slider" class="slider" min="80" max="400" value="120" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AV - Amplitud Sonoridad (dB)</span>
                                <span id="av-value">60</span>
                            </div>
                            <input type="range" id="av-slider" class="slider" min="0" max="80" value="60" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes (Cascada)</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F1 (Hz)</span>
                                <span id="f1-value">450</span>
                            </div>
                            <input type="range" id="f1-slider" class="slider" min="150" max="900" value="450" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F2 (Hz)</span>
                                <span id="f2-value">1450</span>
                            </div>
                            <input type="range" id="f2-slider" class="slider" min="500" max="2500" value="1450" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F3 (Hz)</span>
                                <span id="f3-value">2450</span>
                            </div>
                            <input type="range" id="f3-slider" class="slider" min="1300" max="3500" value="2450" step="10">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Anchos de Banda</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B1 (Hz)</span>
                                <span id="b1-value">50</span>
                            </div>
                            <input type="range" id="b1-slider" class="slider" min="30" max="200" value="50" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B2 (Hz)</span>
                                <span id="b2-value">70</span>
                            </div>
                            <input type="range" id="b2-slider" class="slider" min="30" max="200" value="70" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B3 (Hz)</span>
                                <span id="b3-value">110</span>
                            </div>
                            <input type="range" id="b3-slider" class="slider" min="30" max="300" value="110" step="5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab General -->
            <div id="general-tab" class="tab-content">
                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Fuente Glotal</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F0 - Frecuencia Fundamental (Hz)</span>
                                <span id="gen-f0-value">120</span>
                            </div>
                            <input type="range" id="gen-f0-slider" class="slider" min="80" max="400" value="120" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AV - Amplitud Sonoridad (dB)</span>
                                <span id="gen-av-value">60</span>
                            </div>
                            <input type="range" id="gen-av-slider" class="slider" min="0" max="80" value="60" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AVS - Amplitud Sonoridad Sinusoidal (dB)</span>
                                <span id="gen-avs-value">0</span>
                            </div>
                            <input type="range" id="gen-avs-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Fuentes de Ruido</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AF - Amplitud Fricaci√≥n (dB)</span>
                                <span id="gen-af-value">0</span>
                            </div>
                            <input type="range" id="gen-af-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AH - Amplitud Aspiraci√≥n (dB)</span>
                                <span id="gen-ah-value">0</span>
                            </div>
                            <input type="range" id="gen-ah-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes F1-F3</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F1 (Hz)</span>
                                <span id="gen-f1-value">450</span>
                            </div>
                            <input type="range" id="gen-f1-slider" class="slider" min="150" max="900" value="450" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B1 (Hz)</span>
                                <span id="gen-b1-value">50</span>
                            </div>
                            <input type="range" id="gen-b1-slider" class="slider" min="30" max="200" value="50" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F2 (Hz)</span>
                                <span id="gen-f2-value">1450</span>
                            </div>
                            <input type="range" id="gen-f2-slider" class="slider" min="500" max="2500" value="1450" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B2 (Hz)</span>
                                <span id="gen-b2-value">70</span>
                            </div>
                            <input type="range" id="gen-b2-slider" class="slider" min="30" max="200" value="70" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F3 (Hz)</span>
                                <span id="gen-f3-value">2450</span>
                            </div>
                            <input type="range" id="gen-f3-slider" class="slider" min="1300" max="3500" value="2450" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B3 (Hz)</span>
                                <span id="gen-b3-value">110</span>
                            </div>
                            <input type="range" id="gen-b3-slider" class="slider" min="30" max="300" value="110" step="5">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes F4-F5</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F4 (Hz)</span>
                                <span id="gen-f4-value">3300</span>
                            </div>
                            <input type="range" id="gen-f4-slider" class="slider" min="2500" max="4500" value="3300" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B4 (Hz)</span>
                                <span id="gen-b4-value">120</span>
                            </div>
                            <input type="range" id="gen-b4-slider" class="slider" min="30" max="300" value="120" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F5 (Hz)</span>
                                <span id="gen-f5-value">3750</span>
                            </div>
                            <input type="range" id="gen-f5-slider" class="slider" min="3500" max="4900" value="3750" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B5 (Hz)</span>
                                <span id="gen-b5-value">130</span>
                            </div>
                            <input type="range" id="gen-b5-slider" class="slider" min="30" max="300" value="130" step="5">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Control de Sistema</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Duraci√≥n (segundos)</span>
                                <span id="gen-duration-value">2.0</span>
                            </div>
                            <input type="range" id="gen-duration-slider" class="slider" min="0.5" max="5.0" value="2.0" step="0.1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Frecuencia de Muestreo</span>
                                <span id="gen-sample-rate-value">10000 Hz</span>
                            </div>
                            <select id="gen-sample-rate-select" style="width: 100%; padding: 5px; border-radius: 5px;">
                                <option value="10000">10000 Hz (Original Paper)</option>
                                <option value="22050">22050 Hz</option>
                                <option value="44100">44100 Hz</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="play-controls">
                <button class="play-button" id="play-button" onclick="toggleSound()">‚ñ∂ Reproducir</button>
                <button class="play-button stop" onclick="stopSound()">‚èπ Detener</button>
                <button class="play-button download" onclick="downloadWAV()">üíæ Descargar WAV</button>
            </div>

            <div class="spectrum-container">
                <h3>Respuesta de Formantes (Implementaci√≥n Klatt 1980)</h3>
                <canvas id="spectrum"></canvas>
            </div>

            <div class="info-section">
                <h3>Implementaci√≥n Fiel al Paper Original</h3>
                <p>
                    Esta implementaci√≥n replica exactamente los algoritmos descritos en el paper de Dennis H. Klatt (1980):
                </p>
                <p>
                    <strong>‚Ä¢ Resonadores Digitales:</strong> Ecuaciones de diferencia de segundo orden con transformaci√≥n impulse-invariant
                </p>
                <p>
                    <strong>‚Ä¢ Configuraci√≥n Cascada:</strong> Fuente Glotal ‚Üí RGP ‚Üí F1 ‚Üí F2 ‚Üí F3 ‚Üí F4 ‚Üí F5 ‚Üí Radiaci√≥n
                </p>
                <p>
                    <strong>‚Ä¢ Fuente Glotal:</strong> Tren de impulsos filtrado por resonador paso-bajo (RGP)
                </p>
                <p>
                    <strong>‚Ä¢ Filtro de Radiaci√≥n:</strong> Diferencia primera para simular radiaci√≥n desde los labios
                </p>
                <p>
                    <strong>‚Ä¢ Frecuencia de Muestreo:</strong> 10,000 Hz (como en el paper original)
                </p>
            </div>
        </div>
    </div>

    <script>
        // Clase para resonador digital seg√∫n ecuaciones exactas del paper Klatt
        class KlattDigitalResonator {
            constructor(frequency, bandwidth, sampleRate) {
                this.frequency = frequency;
                this.bandwidth = bandwidth;
                this.sampleRate = sampleRate;
                
                // Estados del resonador (y(nT-T) y y(nT-2T))
                this.y1 = 0;
                this.y2 = 0;
                
                this.calculateCoefficients();
            }
            
            calculateCoefficients() {
                // Implementaci√≥n exacta de las ecuaciones del paper Klatt (1980)
                // Ecuaci√≥n (2) del paper
                const T = 1.0 / this.sampleRate;
                const PI = Math.PI;
                
                if (this.frequency <= 0) {
                    // Resonador paso-bajo cuando F = 0 (RGP)
                    this.C = -Math.exp(-2 * PI * this.bandwidth * T);
                    this.B = 0;
                    this.A = 1 - this.B - this.C;
                } else {
                    // Resonador normal - Ecuaciones exactas del paper
                    this.C = -Math.exp(-2 * PI * this.bandwidth * T);
                    this.B = 2 * Math.exp(-PI * this.bandwidth * T) * Math.cos(2 * PI * this.frequency * T);
                    this.A = 1 - this.B - this.C;
                }
            }
            
            process(input) {
                // Ecuaci√≥n (1) del paper: y(nT) = Ax(nT) + By(nT-T) + Cy(nT-2T)
                const output = this.A * input + this.B * this.y1 + this.C * this.y2;
                
                // Actualizar estados
                this.y2 = this.y1;
                this.y1 = output;
                
                return output;
            }
            
            reset() {
                this.y1 = 0;
                this.y2 = 0;
            }
        }

        // Sintetizador principal siguiendo exactamente el paper
        class KlattSynthesizer {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.currentSource = null;
                
                // Par√°metros seg√∫n Tabla I del paper
                this.params = {
                    F0: 120,      // Fundamental frequency
                    AV: 60,       // Amplitude of voicing
                    AF: 0,        // Amplitude of frication
                    AH: 0,        // Amplitude of aspiration
                    AVS: 0,       // Amplitude of quasi-sinusoidal voicing
                    F1: 450,      // First formant frequency  
                    F2: 1450,     // Second formant frequency
                    F3: 2450,     // Third formant frequency
                    F4: 3300,     // Fourth formant frequency
                    F5: 3750,     // Fifth formant frequency
                    B1: 50,       // First formant bandwidth
                    B2: 70,       // Second formant bandwidth
                    B3: 110,      // Third formant bandwidth
                    B4: 120,      // Fourth formant bandwidth
                    B5: 130,      // Fifth formant bandwidth
                    duration: 2.0,
                    sampleRate: 10000  // Original paper usa 10kHz
                };
                
                this.initializeControls();
                this.drawSpectrum();
                this.createVowelSpace();
                this.showMessage('Sintetizador Klatt inicializado - Implementaci√≥n fiel al paper original', 'success');
            }

            showMessage(text, type = 'success') {
                const messageDiv = document.getElementById('status-message');
                messageDiv.textContent = text;
                messageDiv.className = `status-message ${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            async initializeAudio() {
                if (!this.audioContext) {
                    // Usar la frecuencia de muestreo configurada
                    this.audioContext = new AudioContext({ sampleRate: this.params.sampleRate });
                    console.log('AudioContext creado con sample rate:', this.audioContext.sampleRate);
                }
                
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
                
                return true;
            }

            generateGlottalPulse(sampleIndex, period) {
                // Generar pulso glotal seg√∫n paper Klatt
                // Tren de impulsos en m√∫ltiplos del per√≠odo fundamental
                if (this.params.F0 <= 0) return 0;
                
                const pulsePeriod = Math.floor(this.params.sampleRate / this.params.F0);
                
                if (pulsePeriod > 0 && sampleIndex % pulsePeriod === 0) {
                    // Impulso unitario en inicio de cada per√≠odo
                    return this.dbToLinear(this.params.AV - 60);
                }
                return 0;
            }

            generateNoise() {
                // Generador de ruido pseudo-aleatorio para fricaci√≥n/aspiraci√≥n
                return (Math.random() - 0.5) * 2.0;
            }

            dbToLinear(db) {
                return Math.pow(10, db / 20);
            }

            async synthesizeKlatt() {
                const duration = this.params.duration;
                const sampleRate = this.params.sampleRate;
                const numSamples = Math.floor(duration * sampleRate);
                
                console.log(`S√≠ntesis Klatt: ${numSamples} muestras a ${sampleRate}Hz`);
                
                // Crear resonadores digitales seg√∫n configuraci√≥n cascada del paper
                // Fuente glotal: RGP (F=0, BW=100Hz) seg√∫n paper
                const glottalLPF = new KlattDigitalResonator(0, 100, sampleRate);
                
                // Cascada de formantes F1‚ÜíF2‚ÜíF3‚ÜíF4‚ÜíF5
                const F1_resonator = new KlattDigitalResonator(this.params.F1, this.params.B1, sampleRate);
                const F2_resonator = new KlattDigitalResonator(this.params.F2, this.params.B2, sampleRate);
                const F3_resonator = new KlattDigitalResonator(this.params.F3, this.params.B3, sampleRate);
                const F4_resonator = new KlattDigitalResonator(this.params.F4, this.params.B4, sampleRate);
                const F5_resonator = new KlattDigitalResonator(this.params.F5, this.params.B5, sampleRate);
                
                const audioBuffer = this.audioContext.createBuffer(1, numSamples, sampleRate);
                const outputData = audioBuffer.getChannelData(0);
                
                // Estados para diferencia primera (radiaci√≥n)
                let prevSample = 0;
                
                // S√≠ntesis muestra por muestra
                for (let n = 0; n < numSamples; n++) {
                    const t = n / sampleRate;
                    
                    // 1. Generar fuente glotal (tren de impulsos)
                    let glottalSource = this.generateGlottalPulse(n);
                    
                    // 2. Generar ruido para aspiraci√≥n/fricaci√≥n
                    let noiseSource = this.generateNoise();
                    let aspiration = noiseSource * this.dbToLinear(this.params.AH - 60);
                    let frication = noiseSource * this.dbToLinear(this.params.AF - 60);
                    
                    // 3. Filtro paso-bajo glotal (RGP) - combinar todas las fuentes
                    let combinedSource = glottalSource + aspiration;
                    combinedSource = glottalLPF.process(combinedSource);
                    
                    // 4. Cascada de resonadores de formantes (configuraci√≥n del paper)
                    let signal = F1_resonator.process(combinedSource);
                    signal = F2_resonator.process(signal);
                    signal = F3_resonator.process(signal);
                    signal = F4_resonator.process(signal);
                    signal = F5_resonator.process(signal);
                    
                    // 5. Agregar fricaci√≥n directa (configuraci√≥n paralela)
                    signal += frication;
                    
                    // 6. Filtro de radiaci√≥n (diferencia primera)
                    const radiatedSignal = signal - prevSample;
                    prevSample = signal;
                    
                    // 7. Almacenar muestra final
                    outputData[n] = radiatedSignal * 0.1; // Escalar para volumen apropiado
                }
                
                console.log('S√≠ntesis completada, m√°ximo nivel:', Math.max(...outputData.map(x => Math.abs(x))));
                return audioBuffer;
            }

            async startSound() {
                const success = await this.initializeAudio();
                if (!success) return;
                
                if (this.isPlaying) {
                    this.stopSound();
                }
                
                try {
                    console.log('Iniciando s√≠ntesis Klatt con par√°metros:', this.params);
                    
                    // Generar audio buffer usando implementaci√≥n Klatt
                    const audioBuffer = await this.synthesizeKlatt();
                    
                    // Reproducir el buffer
                    const sourceNode = this.audioContext.createBufferSource();
                    sourceNode.buffer = audioBuffer;
                    sourceNode.connect(this.audioContext.destination);
                    
                    sourceNode.start();
                    this.currentSource = sourceNode;
                    
                    this.isPlaying = true;
                    document.getElementById('play-button').textContent = '‚è∏ Pausar';
                    this.showMessage('S√≠ntesis Klatt reproduciendo', 'success');
                    
                    // Auto-detener cuando termine
                    sourceNode.onended = () => {
                        this.isPlaying = false;
                        document.getElementById('play-button').textContent = '‚ñ∂ Reproducir';
                    };
                    
                } catch (error) {
                    console.error('Error en s√≠ntesis Klatt:', error);
                    this.showMessage('Error en s√≠ntesis: ' + error.message, 'error');
                }
            }

            stopSound() {
                if (this.currentSource) {
                    this.currentSource.stop();
                    this.currentSource = null;
                }
                
                this.isPlaying = false;
                document.getElementById('play-button').textContent = '‚ñ∂ Reproducir';
            }

            async downloadWAV() {
                try {
                    this.showMessage('Generando archivo WAV...', 'success');
                    
                    // Crear contexto temporal para s√≠ntesis
                    const tempContext = new OfflineAudioContext(1, 
                        this.params.duration * this.params.sampleRate, 
                        this.params.sampleRate);
                    
                    // Generar audio usando s√≠ntesis Klatt
                    const audioBuffer = await this.synthesizeKlatt();
                    
                    // Convertir a WAV
                    const wav = this.audioBufferToWav(audioBuffer);
                    const blob = new Blob([wav], { type: 'audio/wav' });
                    
                    // Descargar
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `klatt_synthesis_${this.params.sampleRate}Hz_${Date.now()}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage('Archivo WAV descargado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error descargando WAV:', error);
                    this.showMessage('Error descargando WAV: ' + error.message, 'error');
                }
            }

            audioBufferToWav(buffer) {
                const length = buffer.length;
                const sampleRate = buffer.sampleRate;
                const arrayBuffer = new ArrayBuffer(44 + length * 2);
                const view = new DataView(arrayBuffer);
                
                // WAV header
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, length * 2, true);
                
                // Convert samples to 16-bit PCM
                const channelData = buffer.getChannelData(0);
                let offset = 44;
                for (let i = 0; i < length; i++) {
                    const sample = Math.max(-1, Math.min(1, channelData[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
                
                return arrayBuffer;
            }

            createVowelSpace() {
                const vowelSpace = document.getElementById('vowel-space');
                
                // Valores aproximados para vocales espa√±olas (F1, F2)
                const vowels = {
                    'i': { f1: 300, f2: 2200, x: 0.85, y: 0.15 },
                    'e': { f1: 400, f2: 1800, x: 0.65, y: 0.25 },
                    'a': { f1: 700, f2: 1100, x: 0.35, y: 0.75 },
                    'o': { f1: 500, f2: 1000, x: 0.25, y: 0.45 },
                    'u': { f1: 300, f2: 800, x: 0.15, y: 0.15 }
                };
                
                Object.keys(vowels).forEach(vowel => {
                    const point = document.createElement('div');
                    point.className = `vowel-point ${vowel}`;
                    point.style.left = `${vowels[vowel].x * 100}%`;
                    point.style.top = `${vowels[vowel].y * 100}%`;
                    point.title = `/${vowel}/ (F1: ${vowels[vowel].f1}Hz, F2: ${vowels[vowel].f2}Hz)`;
                    point.onclick = () => this.setVowelFromSpace(vowel);
                    vowelSpace.appendChild(point);
                });
            }

            setVowelFromSpace(vowel) {
                this.setVowelPreset(vowel);
                this.updateVowelSpacePosition();
            }

            updateVowelSpacePosition() {
                // Actualizar posici√≥n en el espacio voc√°lico basado en F1/F2 actuales
                const f1 = this.params.F1;
                const f2 = this.params.F2;
                
                // Convertir F1/F2 a coordenadas x,y aproximadas
                const x = Math.max(0, Math.min(1, (2500 - f2) / 1700));
                const y = Math.max(0, Math.min(1, (f1 - 200) / 600));
                
                // Crear punto actual si no existe
                let currentPoint = document.querySelector('.vowel-point.current');
                if (!currentPoint) {
                    currentPoint = document.createElement('div');
                    currentPoint.className = 'vowel-point current';
                    currentPoint.style.background = '#000';
                    currentPoint.style.border = '3px solid #ff0000';
                    currentPoint.style.zIndex = '10';
                    document.getElementById('vowel-space').appendChild(currentPoint);
                }
                
                currentPoint.style.left = `${x * 100}%`;
                currentPoint.style.top = `${y * 100}%`;
                currentPoint.title = `Actual (F1: ${f1}Hz, F2: ${f2}Hz)`;
            }

            initializeControls() {
                // Configurar todos los sliders para ambas pesta√±as
                const vowelParams = ['f0', 'av', 'f1', 'f2', 'f3', 'b1', 'b2', 'b3'];
                const generalParams = ['f0', 'av', 'avs', 'af', 'ah', 'f1', 'b1', 'f2', 'b2', 'f3', 'b3', 'f4', 'b4', 'f5', 'b5', 'duration'];
                
                // Pesta√±a de vocales
                vowelParams.forEach(param => {
                    this.setupSlider(param, this.getParamName(param));
                });
                
                // Pesta√±a general
                generalParams.forEach(param => {
                    this.setupSlider('gen-' + param, this.getParamName(param));
                });
                
                // Sample rate selector
                const sampleRateSelect = document.getElementById('gen-sample-rate-select');
                if (sampleRateSelect) {
                    sampleRateSelect.addEventListener('change', (e) => {
                        this.params.sampleRate = parseInt(e.target.value);
                        this.audioContext = null; // Force recreate with new sample rate
                        document.getElementById('gen-sample-rate-value').textContent = this.params.sampleRate + ' Hz';
                        this.drawSpectrum();
                    });
                }
            }

            getParamName(param) {
                const paramMap = {
                    'f0': 'F0',
                    'av': 'AV',
                    'avs': 'AVS',
                    'af': 'AF',
                    'ah': 'AH',
                    'f1': 'F1',
                    'f2': 'F2',
                    'f3': 'F3',
                    'f4': 'F4',
                    'f5': 'F5',
                    'b1': 'B1',
                    'b2': 'B2',
                    'b3': 'B3',
                    'b4': 'B4',
                    'b5': 'B5',
                    'duration': 'duration'
                };
                return paramMap[param] || param.toUpperCase();
            }

            setupSlider(sliderId, paramName) {
                const slider = document.getElementById(sliderId + '-slider');
                const valueDisplay = document.getElementById(sliderId + '-value');
                
                if (slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.params[paramName] = value;
                        
                        if (paramName === 'duration') {
                            valueDisplay.textContent = value.toFixed(1);
                        } else {
                            valueDisplay.textContent = value;
                        }
                        
                        this.drawSpectrum();
                        
                        // Actualizar espacio voc√°lico si es F1 o F2
                        if (paramName === 'F1' || paramName === 'F2') {
                            this.updateVowelSpacePosition();
                        }
                    });
                }
            }

            drawSpectrum() {
                const canvas = document.getElementById('spectrum');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const width = canvas.width;
                const height = canvas.height;
                
                ctx.clearRect(0, 0, width, height);
                
                // Dibujar grid
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                const maxFreq = this.params.sampleRate / 2;
                const freqStep = maxFreq / 10;
                
                for (let freq = 0; freq <= maxFreq; freq += freqStep) {
                    const x = (freq / maxFreq) * width;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(Math.round(freq) + 'Hz', x, height - 5);
                }
                
                // Dibujar respuesta te√≥rica seg√∫n ecuaciones de Klatt
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const points = 1000;
                for (let i = 0; i < points; i++) {
                    const freq = (i / points) * maxFreq;
                    const x = (freq / maxFreq) * width;
                    
                    // Calcular respuesta combinada usando las ecuaciones del paper
                    let response = this.calculateFormantResponse(freq);
                    
                    const dB = 20 * Math.log10(Math.abs(response) + 0.001);
                    const normalizedDB = Math.max(0, Math.min(1, (dB + 40) / 60));
                    const y = height - (normalizedDB * height);
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
                
                // Marcadores de formantes
                ctx.strokeStyle = '#E91E63';
                ctx.lineWidth = 2;
                
                const formants = [
                    { freq: this.params.F1, label: 'F1' },
                    { freq: this.params.F2, label: 'F2' },
                    { freq: this.params.F3, label: 'F3' },
                    { freq: this.params.F4, label: 'F4' },
                    { freq: this.params.F5, label: 'F5' }
                ];
                
                formants.forEach(({ freq, label }) => {
                    if (freq > 0 && freq <= maxFreq) {
                        const x = (freq / maxFreq) * width;
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, height);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#E91E63';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x, 20);
                    }
                });
            }

            calculateFormantResponse(frequency) {
                // Calcular respuesta te√≥rica usando las ecuaciones del paper Klatt
                let response = 1;
                
                const formants = [
                    { f: this.params.F1, bw: this.params.B1 },
                    { f: this.params.F2, bw: this.params.B2 },
                    { f: this.params.F3, bw: this.params.B3 },
                    { f: this.params.F4, bw: this.params.B4 },
                    { f: this.params.F5, bw: this.params.B5 }
                ];
                
                formants.forEach(({ f, bw }) => {
                    if (f > 0) {
                        const q = f / Math.max(bw, 1);
                        const formantResponse = q / (1 + Math.pow(q * (frequency - f) / f, 2));
                        response *= formantResponse;
                    }
                });
                
                return response;
            }

            setVowelPreset(vowel) {
                // Valores basados en datos de vocales espa√±olas
                const vowelData = {
                    'a': { F1: 700, B1: 130, F2: 1100, B2: 70, F3: 2600, B3: 160 },
                    'e': { F1: 400, B1: 60, F2: 1800, B2: 90, F3: 2500, B3: 200 },
                    'i': { F1: 300, B1: 45, F2: 2200, B2: 200, F3: 2960, B3: 400 },
                    'o': { F1: 500, B1: 80, F2: 1000, B2: 70, F3: 2300, B3: 70 },
                    'u': { F1: 300, B1: 65, F2: 800, B2: 110, F3: 2200, B3: 140 }
                };
                
                const data = vowelData[vowel];
                if (!data) return;
                
                // Aplicar valores
                Object.keys(data).forEach(param => {
                    this.params[param] = data[param];
                });
                
                // Actualizar interfaz
                this.updateAllSliders();
                this.drawSpectrum();
                this.updateVowelSpacePosition();
                
                this.showMessage(`Vocal /${vowel}/ configurada`, 'success');
            }

            updateAllSliders() {
                ['f0', 'av', 'f1', 'b1', 'f2', 'b2', 'f3', 'b3'].forEach(param => {
                    this.updateSlider(param, this.params[this.getParamName(param)]);
                    this.updateSlider('gen-' + param, this.params[this.getParamName(param)]);
                });
            }

            updateSlider(sliderId, value) {
                const slider = document.getElementById(sliderId + '-slider');
                const valueDisplay = document.getElementById(sliderId + '-value');
                
                if (slider && valueDisplay) {
                    slider.value = value;
                    if (sliderId.includes('duration')) {
                        valueDisplay.textContent = value.toFixed(1);
                    } else {
                        valueDisplay.textContent = value;
                    }
                }
            }
        }

        // Variables globales
        let synthesizer;

        // Funciones de cambio de pesta√±as
        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activar bot√≥n correspondiente
            event.target.classList.add('active');
        }

        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', () => {
            synthesizer = new KlattSynthesizer();
        });

        // Funciones de control
        async function toggleSound() {
            if (!synthesizer.isPlaying) {
                await synthesizer.startSound();
            } else {
                synthesizer.stopSound();
            }
        }

        function stopSound() {
            synthesizer.stopSound();
        }

        function setVowel(vowel) {
            synthesizer.setVowelPreset(vowel);
        }

        async function downloadWAV() {
            await synthesizer.downloadWAV();
        }

        // Redimensionamiento de canvas
        window.addEventListener('resize', () => {
            if (synthesizer) {
                synthesizer.drawSpectrum();
            }
        });
    </script>
</body>
</html>
