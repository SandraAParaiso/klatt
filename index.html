<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintetizador de Formantes Klatt 1980</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .synthesis-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .control-group:hover {
            transform: translateY(-3px);
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            appearance: none;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .play-controls {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .play-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            font-weight: 600;
        }

        .play-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.6);
        }

        .play-button.stop {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .play-button.download {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.4);
        }

        .play-button.reset {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .vowel-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .vowel-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
            min-width: 120px;
        }

        .vowel-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .code-editor {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .code-editor h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
        }

        .code-textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .code-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .spectrum-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .spectrum-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
        }

        #spectrum {
            width: 100%;
            height: 400px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-section {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #2196f3;
        }

        .info-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .info-section p {
            line-height: 1.6;
            color: #424242;
            margin-bottom: 10px;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .vowel-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }

            .play-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sintetizador de Formantes Klatt 1980</h1>
            <p>Software for a cascade/parallel formant synthesizer (Klatt, 1980)</p>
        </div>
        
        <div class="main-content">
            <div id="status-message" class="status-message" style="display: none;"></div>
            
            <div class="synthesis-tabs">
                <button class="tab-button active" onclick="switchTab('vowels')">S√≠ntesis de Vocales</button>
                <button class="tab-button" onclick="switchTab('general')">S√≠ntesis General (39 Par√°metros)</button>
                <button class="tab-button" onclick="switchTab('code')">Editor de C√≥digo</button>
            </div>

            <!-- Tab de Vocales -->
            <div id="vowels-tab" class="tab-content active">
                <div class="vowel-buttons">
                    <button class="vowel-button" onclick="setVowel('i')">/i/ (313, 2200)</button>
                    <button class="vowel-button" onclick="setVowel('e')">/e/ (457, 1926)</button>
                    <button class="vowel-button" onclick="setVowel('a')">/a/ (699, 1471)</button>
                    <button class="vowel-button" onclick="setVowel('o')">/o/ (495, 1070)</button>
                    <button class="vowel-button" onclick="setVowel('u')">/u/ (349, 877)</button>
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Fuente Glotal</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F0 - Frecuencia Fundamental (Hz)</span>
                                <span id="f0-value">140</span>
                            </div>
                            <input type="range" id="f0-slider" class="slider" min="80" max="400" value="140" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AV - Amplitud Sonoridad (dB)</span>
                                <span id="av-value">70</span>
                            </div>
                            <input type="range" id="av-slider" class="slider" min="0" max="80" value="70" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes F1-F3</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F1 (Hz)</span>
                                <span id="f1-value">699</span>
                            </div>
                            <input type="range" id="f1-slider" class="slider" min="150" max="900" value="699" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F2 (Hz)</span>
                                <span id="f2-value">1471</span>
                            </div>
                            <input type="range" id="f2-slider" class="slider" min="500" max="2500" value="1471" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F3 (Hz)</span>
                                <span id="f3-value">2500</span>
                            </div>
                            <input type="range" id="f3-slider" class="slider" min="1300" max="3500" value="2500" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Anchos de Banda</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B1 (Hz)</span>
                                <span id="b1-value">60</span>
                            </div>
                            <input type="range" id="b1-slider" class="slider" min="40" max="500" value="60" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B2 (Hz)</span>
                                <span id="b2-value">70</span>
                            </div>
                            <input type="range" id="b2-slider" class="slider" min="40" max="500" value="70" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B3 (Hz)</span>
                                <span id="b3-value">160</span>
                            </div>
                            <input type="range" id="b3-slider" class="slider" min="40" max="500" value="160" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes F4-F5</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F4 (Hz)</span>
                                <span id="f4-value">3500</span>
                            </div>
                            <input type="range" id="f4-slider" class="slider" min="2500" max="4500" value="3500" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B4 (Hz)</span>
                                <span id="b4-value">150</span>
                            </div>
                            <input type="range" id="b4-slider" class="slider" min="100" max="500" value="150" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F5 (Hz)</span>
                                <span id="f5-value">4500</span>
                            </div>
                            <input type="range" id="f5-slider" class="slider" min="3500" max="4900" value="4500" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B5 (Hz)</span>
                                <span id="b5-value">200</span>
                            </div>
                            <input type="range" id="b5-slider" class="slider" min="150" max="700" value="200" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Control de Sistema</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Duraci√≥n (segundos)</span>
                                <span id="duration-value">2.0</span>
                            </div>
                            <input type="range" id="duration-slider" class="slider" min="0.5" max="5.0" value="2.0" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="play-controls">
                    <button class="play-button" id="play-button-vowels" onclick="toggleSound()">‚ñ∂ Reproducir</button>
                    <button class="play-button stop" onclick="stopSound()">‚èπ Detener</button>
                    <button class="play-button reset" onclick="resetToDefaults('vowels')">üîÑ Resetear</button>
                    <button class="play-button download" onclick="downloadWAV()">üíæ Descargar WAV</button>
                </div>
            </div>

            <!-- Tab General con 39 par√°metros -->
            <div id="general-tab" class="tab-content">
                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Fuentes de Sonido</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AV - Amplitud Sonoridad (dB)</span>
                                <span id="gen-av-value">60</span>
                            </div>
                            <input type="range" id="gen-av-slider" class="slider" min="0" max="80" value="60" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AF - Amplitud Fricaci√≥n (dB)</span>
                                <span id="gen-af-value">0</span>
                            </div>
                            <input type="range" id="gen-af-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AH - Amplitud Aspiraci√≥n (dB)</span>
                                <span id="gen-ah-value">0</span>
                            </div>
                            <input type="range" id="gen-ah-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AVS - Amplitud Sonoridad Sinusoidal (dB)</span>
                                <span id="gen-avs-value">0</span>
                            </div>
                            <input type="range" id="gen-avs-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F0 - Frecuencia Fundamental (Hz)</span>
                                <span id="gen-f0-value">120</span>
                            </div>
                            <input type="range" id="gen-f0-slider" class="slider" min="0" max="500" value="120" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes F1-F3</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F1 (Hz)</span>
                                <span id="gen-f1-value">450</span>
                            </div>
                            <input type="range" id="gen-f1-slider" class="slider" min="150" max="900" value="450" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F2 (Hz)</span>
                                <span id="gen-f2-value">1450</span>
                            </div>
                            <input type="range" id="gen-f2-slider" class="slider" min="500" max="2500" value="1450" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F3 (Hz)</span>
                                <span id="gen-f3-value">2450</span>
                            </div>
                            <input type="range" id="gen-f3-slider" class="slider" min="1300" max="3500" value="2450" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F4 (Hz)</span>
                                <span id="gen-f4-value">3300</span>
                            </div>
                            <input type="range" id="gen-f4-slider" class="slider" min="2500" max="4500" value="3300" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F5 (Hz)</span>
                                <span id="gen-f5-value">3750</span>
                            </div>
                            <input type="range" id="gen-f5-slider" class="slider" min="3500" max="4900" value="3750" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Anchos de Banda</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B1 (Hz)</span>
                                <span id="gen-b1-value">50</span>
                            </div>
                            <input type="range" id="gen-b1-slider" class="slider" min="40" max="500" value="50" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B2 (Hz)</span>
                                <span id="gen-b2-value">70</span>
                            </div>
                            <input type="range" id="gen-b2-slider" class="slider" min="40" max="500" value="70" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B3 (Hz)</span>
                                <span id="gen-b3-value">110</span>
                            </div>
                            <input type="range" id="gen-b3-slider" class="slider" min="40" max="500" value="110" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B4 (Hz)</span>
                                <span id="gen-b4-value">250</span>
                            </div>
                            <input type="range" id="gen-b4-slider" class="slider" min="100" max="500" value="250" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B5 (Hz)</span>
                                <span id="gen-b5-value">200</span>
                            </div>
                            <input type="range" id="gen-b5-slider" class="slider" min="150" max="700" value="200" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Amplitudes Paralelas</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A1 - Amplitud F1 (dB)</span>
                                <span id="gen-a1-value">0</span>
                            </div>
                            <input type="range" id="gen-a1-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A2 - Amplitud F2 (dB)</span>
                                <span id="gen-a2-value">0</span>
                            </div>
                            <input type="range" id="gen-a2-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A3 - Amplitud F3 (dB)</span>
                                <span id="gen-a3-value">0</span>
                            </div>
                            <input type="range" id="gen-a3-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A4 - Amplitud F4 (dB)</span>
                                <span id="gen-a4-value">0</span>
                            </div>
                            <input type="range" id="gen-a4-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A5 - Amplitud F5 (dB)</span>
                                <span id="gen-a5-value">0</span>
                            </div>
                            <input type="range" id="gen-a5-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A6 - Amplitud F6 (dB)</span>
                                <span id="gen-a6-value">0</span>
                            </div>
                            <input type="range" id="gen-a6-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AB - Amplitud Bypass (dB)</span>
                                <span id="gen-ab-value">0</span>
                            </div>
                            <input type="range" id="gen-ab-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AN - Amplitud Nasal (dB)</span>
                                <span id="gen-an-value">0</span>
                            </div>
                            <input type="range" id="gen-an-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Par√°metros Glotales</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FGP - Frecuencia Glotal (Hz)</span>
                                <span id="gen-fgp-value">0</span>
                            </div>
                            <input type="range" id="gen-fgp-slider" class="slider" min="0" max="600" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BGP - Ancho Banda Glotal (Hz)</span>
                                <span id="gen-bgp-value">100</span>
                            </div>
                            <input type="range" id="gen-bgp-slider" class="slider" min="100" max="2000" value="100" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FGZ - Frecuencia Zero Glotal (Hz)</span>
                                <span id="gen-fgz-value">1500</span>
                            </div>
                            <input type="range" id="gen-fgz-slider" class="slider" min="0" max="5000" value="1500" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BGZ - Ancho Banda Zero Glotal (Hz)</span>
                                <span id="gen-bgz-value">6000</span>
                            </div>
                            <input type="range" id="gen-bgz-slider" class="slider" min="100" max="9000" value="6000" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BGS - Ancho Banda GS (Hz)</span>
                                <span id="gen-bgs-value">200</span>
                            </div>
                            <input type="range" id="gen-bgs-slider" class="slider" min="100" max="1000" value="200" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Par√°metros Nasales</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FNZ - Frecuencia Zero Nasal (Hz)</span>
                                <span id="gen-fnz-value">250</span>
                            </div>
                            <input type="range" id="gen-fnz-slider" class="slider" min="200" max="700" value="250" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FNP - Frecuencia Polo Nasal (Hz)</span>
                                <span id="gen-fnp-value">250</span>
                            </div>
                            <input type="range" id="gen-fnp-slider" class="slider" min="200" max="500" value="250" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BNP - Ancho Banda Polo Nasal (Hz)</span>
                                <span id="gen-bnp-value">100</span>
                            </div>
                            <input type="range" id="gen-bnp-slider" class="slider" min="50" max="500" value="100" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BNZ - Ancho Banda Zero Nasal (Hz)</span>
                                <span id="gen-bnz-value">100</span>
                            </div>
                            <input type="range" id="gen-bnz-slider" class="slider" min="50" max="500" value="100" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Control de Sistema</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>SW - Switch Cascada/Paralelo</span>
                                <span id="gen-sw-value">0</span>
                            </div>
                            <input type="range" id="gen-sw-slider" class="slider" min="0" max="1" value="0" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>SR - Frecuencia Muestreo (Hz)</span>
                                <span id="gen-sr-value">10000</span>
                            </div>
                            <select id="gen-sr-select" style="width: 100%; padding: 5px; border-radius: 5px;">
                                <option value="10000" selected>10000 Hz (Original Klatt)</option>
                                <option value="22050">22050 Hz</option>
                                <option value="44100">44100 Hz</option>
                            </select>
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>NWS - Muestras por Chunk</span>
                                <span id="gen-nws-value">50</span>
                            </div>
                            <input type="range" id="gen-nws-slider" class="slider" min="1" max="200" value="50" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>GO - Control de Ganancia (dB)</span>
                                <span id="gen-go-value">47</span>
                            </div>
                            <input type="range" id="gen-go-slider" class="slider" min="0" max="80" value="47" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>NFC - N√∫mero Formantes Cascada</span>
                                <span id="gen-nfc-value">5</span>
                            </div>
                            <input type="range" id="gen-nfc-slider" class="slider" min="4" max="6" value="5" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F6 - Sexto Formante (Hz)</span>
                                <span id="gen-f6-value">4900</span>
                            </div>
                            <input type="range" id="gen-f6-slider" class="slider" min="4000" max="4999" value="4900" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B6 - Ancho Banda F6 (Hz)</span>
                                <span id="gen-b6-value">1000</span>
                            </div>
                            <input type="range" id="gen-b6-slider" class="slider" min="200" max="2000" value="1000" step="1">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Duraci√≥n (segundos)</span>
                                <span id="gen-duration-value">2.0</span>
                            </div>
                            <input type="range" id="gen-duration-slider" class="slider" min="0.5" max="5.0" value="2.0" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="play-controls">
                    <button class="play-button" id="play-button-general" onclick="toggleSound()">‚ñ∂ Reproducir</button>
                    <button class="play-button stop" onclick="stopSound()">‚èπ Detener</button>
                    <button class="play-button reset" onclick="resetToDefaults('general')">üîÑ Resetear</button>
                    <button class="play-button download" onclick="downloadWAV()">üíæ Descargar WAV</button>
                </div>
            </div>

            <!-- Tab Editor de C√≥digo -->
            <div id="code-tab" class="tab-content">
                <div class="code-editor">
                    <h3>Editor de C√≥digo de S√≠ntesis</h3>
                    <p style="text-align: center; margin-bottom: 15px; color: #666;">
                        Formato: TIME=ms; PARAM=valor; TIME +ms; PARAM=valor...
                    </p>
                    <textarea id="code-textarea" class="code-textarea" placeholder="Ejemplo:
TIME=000; AV=0
TIME +50; F0=140; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +250; F0=110; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +50; AV=0"></textarea>
                    <div class="code-buttons">
                        <button class="play-button" onclick="parseAndSynthesize()">üéµ Sintetizar C√≥digo</button>
                        <button class="play-button reset" onclick="loadExampleCode()">üìã Cargar Ejemplo</button>
                        <button class="play-button reset" onclick="clearCode()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <div class="play-controls">
                    <button class="play-button" id="play-button-code" onclick="toggleSound()">‚ñ∂ Reproducir</button>
                    <button class="play-button stop" onclick="stopSound()">‚èπ Detener</button>
                    <button class="play-button download" onclick="downloadWAV()">üíæ Descargar WAV</button>
                </div>
            </div>

            <div class="spectrum-container">
                <h3>Respuesta de Formantes - Implementaci√≥n Klatt 1980</h3>
                <canvas id="spectrum"></canvas>
            </div>

            <div class="info-section">
                <h3>Implementaci√≥n Completa del Sintetizador Klatt 1980</h3>
                <p>
                    Esta implementaci√≥n replica exactamente los algoritmos descritos en el paper de Dennis H. Klatt (1980):
                    "Software for a cascade/parallel formant synthesizer" - J. Acoust. Soc. Am. 67(3), Marzo 1980.
                </p>
                <p>
                    <strong>‚Ä¢ 39 Par√°metros de Control:</strong> Todos los par√°metros originales del paper (Tabla I)
                </p>
                <p>
                    <strong>‚Ä¢ Resonadores Digitales:</strong> Ecuaciones exactas: y(nT) = Ax(nT) + By(nT-T) + Cy(nT-2T)
                </p>
                <p>
                    <strong>‚Ä¢ Configuraci√≥n Cascada/Paralelo:</strong> Switch SW para alternar entre modos
                </p>
                <p>
                    <strong>‚Ä¢ Frecuencia de Muestreo:</strong> 10,000 Hz por defecto (como en el paper original)
                </p>
                <p>
                    <strong>‚Ä¢ Valores de Vocales:</strong> Basados en la imagen proporcionada y c√≥digo de ejemplo
                </p>
                <p>
                    <strong>‚Ä¢ Editor de C√≥digo:</strong> Permite s√≠ntesis temporal con formato TIME=ms; PARAM=valor
                </p>
            </div>
        </div>
    </div>

    <script>
        // Clase para resonador digital seg√∫n ecuaciones exactas del paper Klatt
        class KlattDigitalResonator {
            constructor(frequency, bandwidth, sampleRate) {
                this.frequency = frequency;
                this.bandwidth = bandwidth;
                this.sampleRate = sampleRate;
                
                // Estados del resonador (y(nT-T) y y(nT-2T))
                this.y1 = 0;
                this.y2 = 0;
                
                this.calculateCoefficients();
            }
            
            calculateCoefficients() {
                // Implementaci√≥n exacta de las ecuaciones del paper Klatt (1980)
                // Ecuaci√≥n (2) del paper
                const T = 1.0 / this.sampleRate;
                const PI = Math.PI;
                
                if (this.frequency <= 0) {
                    // Resonador paso-bajo cuando F = 0 (RGP)
                    this.C = -Math.exp(-2 * PI * this.bandwidth * T);
                    this.B = 0;
                    this.A = 1 - this.B - this.C;
                } else {
                    // Resonador normal - Ecuaciones exactas del paper
                    this.C = -Math.exp(-2 * PI * this.bandwidth * T);
                    this.B = 2 * Math.exp(-PI * this.bandwidth * T) * Math.cos(2 * PI * this.frequency * T);
                    this.A = 1 - this.B - this.C;
                }
                
                // Normalizaci√≥n para mantener ganancia unitaria a DC seg√∫n paper
                if (this.frequency > 0) {
                    const dcGain = this.A / (1 - this.B - this.C);
                    if (Math.abs(dcGain) > 1e-10) {
                        this.A = this.A / dcGain;
                    }
                }
            }
            
            process(input) {
                // Ecuaci√≥n (1) del paper: y(nT) = Ax(nT) + By(nT-T) + Cy(nT-2T)
                const output = this.A * input + this.B * this.y1 + this.C * this.y2;
                
                // Actualizar estados
                this.y2 = this.y1;
                this.y1 = output;
                
                return output;
            }
            
            reset() {
                this.y1 = 0;
                this.y2 = 0;
            }
            
            // Calcular respuesta en frecuencia para gr√°fico
            getFrequencyResponse(frequency) {
                const T = 1.0 / this.sampleRate;
                const omega = 2 * Math.PI * frequency * T;
                const z_real = Math.cos(omega);
                const z_imag = Math.sin(omega);
                
                // H(z) = A / (1 - B*z^-1 - C*z^-2)
                const denom_real = 1 - this.B * z_real - this.C * (z_real * z_real - z_imag * z_imag);
                const denom_imag = -(-this.B * z_imag - this.C * (-2 * z_real * z_imag));
                
                const magnitude_squared = (denom_real * denom_real + denom_imag * denom_imag);
                const response_magnitude = Math.abs(this.A) / Math.sqrt(magnitude_squared);
                
                return response_magnitude;
            }
        }

        // Sintetizador principal siguiendo exactamente el paper
        class KlattSynthesizer {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.currentSource = null;
                this.timeSequence = null;
                
                // Par√°metros por defecto seg√∫n Tabla I del paper Klatt 1980
                this.defaultParams = {
                    // Par√°metros variables seg√∫n el paper
                    AV: 60,    // Amplitude of voicing (dB)
                    AF: 0,     // Amplitude of frication (dB)
                    AH: 0,     // Amplitude of aspiration (dB)
                    AVS: 0,    // Amplitude of sinusoidal voicing (dB)
                    F0: 120,   // Fundamental frequency (Hz)
                    F1: 450,   // First formant frequency (Hz)
                    F2: 1450,  // Second formant frequency (Hz)
                    F3: 2450,  // Third formant frequency (Hz)
                    F4: 3300,  // Fourth formant frequency (Hz)
                    F5: 3750,  // Fifth formant frequency (Hz)
                    FNZ: 250,  // Nasal zero frequency (Hz)
                    A1: 0,     // First formant amplitude (dB)
                    A2: 0,     // Second formant amplitude (dB)
                    A3: 0,     // Third formant amplitude (dB)
                    A4: 0,     // Fourth formant amplitude (dB)
                    A5: 0,     // Fifth formant amplitude (dB)
                    A6: 0,     // Sixth formant amplitude (dB)
                    AB: 0,     // Bypass path amplitude (dB)
                    B1: 50,    // First formant bandwidth (Hz)
                    B2: 70,    // Second formant bandwidth (Hz)
                    B3: 110,   // Third formant bandwidth (Hz)
                    
                    // Par√°metros constantes seg√∫n el paper
                    SW: 0,     // Cascade/parallel switch (0=CASCADE, 1=PARALLEL)
                    FGP: 0,    // Glottal resonator 1 frequency (Hz)
                    BGP: 100,  // Glottal resonator 1 bandwidth (Hz)
                    FGZ: 1500, // Glottal zero frequency (Hz)
                    BGZ: 6000, // Glottal zero bandwidth (Hz)
                    B4: 250,   // Fourth formant bandwidth (Hz)
                    B5: 200,   // Fifth formant bandwidth (Hz)
                    F6: 4900,  // Sixth formant frequency (Hz)
                    B6: 1000,  // Sixth formant bandwidth (Hz)
                    FNP: 250,  // Nasal pole frequency (Hz)
                    BNP: 100,  // Nasal pole bandwidth (Hz)
                    BNZ: 100,  // Nasal zero bandwidth (Hz)
                    BGS: 200,  // Glottal resonator 2 bandwidth (Hz)
                    SR: 10000, // Sampling rate (Hz) - Original paper
                    NWS: 50,   // Number of waveform samples per chunk
                    GO: 47,    // Overall gain control (dB)
                    NFC: 5,    // Number of cascaded formants
                    AN: 0,     // Nasal formant amplitude (dB)
                    
                    // Control adicional
                    duration: 2.0
                };
                
                this.params = { ...this.defaultParams };
                
                this.initializeControls();
                this.drawSpectrum();
                this.showMessage('Sintetizador Klatt 1980 inicializado', 'success');
            }

            showMessage(text, type = 'success') {
                const messageDiv = document.getElementById('status-message');
                messageDiv.textContent = text;
                messageDiv.className = `status-message ${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            async initializeAudio() {
                if (!this.audioContext) {
                    this.audioContext = new AudioContext({ sampleRate: this.params.SR });
                    console.log('AudioContext creado con sample rate:', this.audioContext.sampleRate);
                }
                
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
                
                return true;
            }

            dbToLinear(db) {
                return Math.pow(10, db / 20);
            }

            generateGlottalSource(n, samplesPerPeriod) {
                // Generar tren de impulsos glotal seg√∫n paper Klatt
                if (this.params.F0 <= 0 || this.params.AV <= 0) return 0;
                
                // Un impulso cada per√≠odo fundamental
                if (samplesPerPeriod > 0 && n % Math.floor(samplesPerPeriod) === 0) {
                    // Amplitud del impulso normalizada y consistente
                    // La amplitud se controla principalmente por AV, no por F0
                    return 1.0; // Amplitud constante, el control de volumen se hace en cascada
                }
                return 0;
            }

            generateNoise() {
                // Generador de ruido pseudo-aleatorio para fricaci√≥n/aspiraci√≥n
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += Math.random() - 0.5;
                }
                return sum / 6; // Normalizar aproximadamente
            }

            async synthesizeKlatt() {
                let duration, sampleRate, numSamples;
                
                if (this.timeSequence && this.timeSequence.length > 0) {
                    // Usar secuencia temporal del c√≥digo
                    const lastEvent = this.timeSequence[this.timeSequence.length - 1];
                    duration = (lastEvent.time + 100) / 1000; // Agregar 100ms al final
                    sampleRate = this.params.SR;
                    numSamples = Math.floor(duration * sampleRate);
                } else {
                    // Usar duraci√≥n fija
                    duration = this.params.duration;
                    sampleRate = this.params.SR;
                    numSamples = Math.floor(duration * sampleRate);
                }
                
                console.log(`S√≠ntesis Klatt: ${numSamples} muestras a ${sampleRate}Hz`);
                
                // Crear resonadores digitales seg√∫n configuraci√≥n cascada del paper
                const resonators = {
                    RGP: new KlattDigitalResonator(this.params.FGP, this.params.BGP, sampleRate), // Glottal low-pass
                    RGZ: new KlattDigitalResonator(this.params.FGZ, this.params.BGZ, sampleRate), // Glottal zero
                    RGS: new KlattDigitalResonator(0, this.params.BGS, sampleRate), // Quasi-sinusoidal
                    F1: new KlattDigitalResonator(this.params.F1, this.params.B1, sampleRate),
                    F2: new KlattDigitalResonator(this.params.F2, this.params.B2, sampleRate),
                    F3: new KlattDigitalResonator(this.params.F3, this.params.B3, sampleRate),
                    F4: new KlattDigitalResonator(this.params.F4, this.params.B4, sampleRate),
                    F5: new KlattDigitalResonator(this.params.F5, this.params.B5, sampleRate),
                    F6: new KlattDigitalResonator(this.params.F6, this.params.B6, sampleRate),
                    FNP: new KlattDigitalResonator(this.params.FNP, this.params.BNP, sampleRate), // Nasal pole
                    FNZ: new KlattDigitalResonator(this.params.FNZ, this.params.BNZ, sampleRate)  // Nasal zero
                };
                
                const audioBuffer = this.audioContext.createBuffer(1, numSamples, sampleRate);
                const outputData = audioBuffer.getChannelData(0);
                
                // Estados para diferencia primera (radiaci√≥n) - Ecuaci√≥n (7)
                let prevSample = 0;
                
                // S√≠ntesis muestra por muestra - algoritmo del paper
                for (let n = 0; n < numSamples; n++) {
                    // Actualizar par√°metros si hay secuencia temporal
                    if (this.timeSequence) {
                        this.updateParametersForTime(n / sampleRate * 1000);
                        // Recalcular coeficientes de resonadores si hay cambios significativos
                        Object.values(resonators).forEach(resonator => {
                            resonator.calculateCoefficients();
                        });
                    }
                    
                    const samplesPerPeriod = this.params.F0 > 0 ? sampleRate / this.params.F0 : 0;
                    
                    // 1. Generar fuente glotal (tren de impulsos)
                    let glottalSource = this.generateGlottalSource(n, samplesPerPeriod);
                    
                    // 2. Generar fuentes de ruido
                    let noiseSource = this.generateNoise();
                    let aspiration = 0;
                    let frication = 0;
                    
                    if (this.params.AH > 0) {
                        aspiration = noiseSource * this.dbToLinear(this.params.AH - 60);
                    }
                    
                    if (this.params.AF > 0) {
                        frication = noiseSource * this.dbToLinear(this.params.AF - 60);
                    }
                    
                    // 3. Procesamiento seg√∫n configuraci√≥n cascada/paralelo
                    let signal = 0;
                    
                    if (this.params.SW === 0) {
                        // Modo CASCADA (para sonorantes) - Configuraci√≥n del paper
                        let vocalTractInput = glottalSource + aspiration;
                        
                        // Filtro paso-bajo glotal (RGP) - Secci√≥n I.B del paper
                        signal = resonators.RGP.process(vocalTractInput);
                        
                        // Anti-resonador glotal (RGZ) - Para modelar espectro glotal
                        // signal = resonators.RGZ.process(signal);
                        
                        // Cascada de resonadores de formantes - Figure 6 del paper
                        signal = resonators.F1.process(signal);
                        signal = resonators.F2.process(signal);
                        signal = resonators.F3.process(signal);
                        if (this.params.NFC >= 4) signal = resonators.F4.process(signal);
                        if (this.params.NFC >= 5) signal = resonators.F5.process(signal);
                        if (this.params.NFC >= 6) signal = resonators.F6.process(signal);
                        
                        // Procesamiento nasal si aplica
                        if (this.params.AN > 0) {
                            signal = resonators.FNP.process(signal);
                            signal = resonators.FNZ.process(signal);
                        }
                        
                        // Amplitud constante mejorada para todas las vocales
                        const formantAmplitudeCompensation = this.calculateFormantAmplitudeCompensation();
                        signal *= formantAmplitudeCompensation;
                        
                        // Aplicar amplitud de sonoridad AV de forma consistente
                        const voicingAmplitude = this.dbToLinear(this.params.AV - 60);
                        signal *= voicingAmplitude;
                        
                    } else {
                        // Modo PARALELO (para fricativas)
                        // M√∫ltiples ramas en paralelo
                        let parallelSum = 0;
                        
                        if (this.params.A1 > 0) {
                            parallelSum += this.dbToLinear(this.params.A1 - 60) * 
                                          resonators.F1.process(glottalSource + frication);
                        }
                        if (this.params.A2 > 0) {
                            parallelSum += this.dbToLinear(this.params.A2 - 60) * 
                                          resonators.F2.process(glottalSource + frication);
                        }
                        if (this.params.A3 > 0) {
                            parallelSum += this.dbToLinear(this.params.A3 - 60) * 
                                          resonators.F3.process(glottalSource + frication);
                        }
                        if (this.params.A4 > 0) {
                            parallelSum += this.dbToLinear(this.params.A4 - 60) * 
                                          resonators.F4.process(glottalSource + frication);
                        }
                        if (this.params.A5 > 0) {
                            parallelSum += this.dbToLinear(this.params.A5 - 60) * 
                                          resonators.F5.process(glottalSource + frication);
                        }
                        if (this.params.A6 > 0) {
                            parallelSum += this.dbToLinear(this.params.A6 - 60) * 
                                          resonators.F6.process(glottalSource + frication);
                        }
                        if (this.params.AB > 0) {
                            parallelSum += this.dbToLinear(this.params.AB - 60) * 
                                          (glottalSource + frication);
                        }
                        
                        signal = parallelSum;
                    }
                    
                    // 4. Filtro de radiaci√≥n (diferencia primera) - Ecuaci√≥n (7) del paper
                    const radiatedSignal = signal - prevSample;
                    prevSample = signal;
                    
                    // 5. Control de ganancia general
                    const gainFactor = this.dbToLinear(this.params.GO - 60);
                    
                    // 6. Almacenar muestra final con escalado apropiado
                    outputData[n] = radiatedSignal * gainFactor * 0.05;
                }
                
                console.log('S√≠ntesis completada, m√°ximo nivel:', Math.max(...outputData.map(x => Math.abs(x))));
                return audioBuffer;
            }

            // Nueva funci√≥n para compensar diferencias de amplitud entre vocales
            calculateFormantAmplitudeCompensation() {
                // Compensaci√≥n espec√≠fica para igualar volumen percibido entre todas las vocales
                const f1 = this.params.F1;
                const f2 = this.params.F2;
                
                // Compensaci√≥n espec√≠fica por vocal basada en F1 y F2
                let compensation = 1.0;
                
                if (f1 < 400 && f2 < 1000) {
                    // Vocal /u/ (F1‚âà349, F2‚âà877) - mayor amplificaci√≥n
                    compensation = 2.8;
                } else if (f1 > 450 && f1 < 550 && f2 < 1200) {
                    // Vocal /o/ (F1‚âà495, F2‚âà1070) - amplificaci√≥n alta
                    compensation = 2.4;
                } else if (f1 < 400 && f2 > 2000) {
                    // Vocal /i/ (F1‚âà313, F2‚âà2200) - amplificaci√≥n moderada
                    compensation = 1.4;
                } else if (f1 > 400 && f1 < 500 && f2 > 1800) {
                    // Vocal /e/ (F1‚âà457, F2‚âà1926) - amplificaci√≥n ligera
                    compensation = 1.3;
                } else if (f1 > 600) {
                    // Vocal /a/ (F1‚âà699, F2‚âà1471) - referencia base
                    compensation = 1.0;
                } else {
                    // Otros casos - amplificaci√≥n por defecto
                    compensation = 1.5;
                }
                
                // Factor adicional basado en ancho de banda total
                const totalBandwidth = this.params.B1 + this.params.B2 + this.params.B3;
                const bandwidthFactor = Math.sqrt(200 / Math.max(totalBandwidth, 100));
                
                return compensation * bandwidthFactor;
            }

            updateParametersForTime(timeMs) {
                if (!this.timeSequence) return;
                
                // Encontrar el evento de tiempo apropiado
                let currentEvent = this.timeSequence[0];
                for (let i = 0; i < this.timeSequence.length; i++) {
                    if (this.timeSequence[i].time <= timeMs) {
                        currentEvent = this.timeSequence[i];
                    } else {
                        break;
                    }
                }
                
                // Actualizar par√°metros con los valores del evento actual
                Object.assign(this.params, currentEvent.params);
            }

            parseTimeCode(code) {
                const lines = code.split('\n').map(line => line.trim()).filter(line => line);
                const timeSequence = [];
                let currentTime = 0;
                let currentParams = {};
                
                for (const line of lines) {
                    const parts = line.split(';').map(part => part.trim()).filter(part => part);
                    
                    for (const part of parts) {
                        if (part.startsWith('TIME')) {
                            const timeMatch = part.match(/TIME\s*([+=]?)(\d+)/);
                            if (timeMatch) {
                                const operator = timeMatch[1];
                                const value = parseInt(timeMatch[2]);
                                
                                if (operator === '+') {
                                    currentTime += value;
                                } else {
                                    currentTime = value;
                                }
                            }
                        } else {
                            const paramMatch = part.match(/(\w+)\s*=\s*([+-]?\d*\.?\d+)/);
                            if (paramMatch) {
                                const paramName = paramMatch[1];
                                const paramValue = parseFloat(paramMatch[2]);
                                currentParams[paramName] = paramValue;
                                
                                // Agregar evento de tiempo
                                timeSequence.push({
                                    time: currentTime,
                                    params: { ...currentParams }
                                });
                            }
                        }
                    }
                }
                
                return timeSequence;
            }

            async startSound() {
                const success = await this.initializeAudio();
                if (!success) return;
                
                if (this.isPlaying) {
                    this.stopSound();
                }
                
                try {
                    console.log('Iniciando s√≠ntesis Klatt con par√°metros:', this.params);
                    
                    // Generar audio buffer usando implementaci√≥n Klatt
                    const audioBuffer = await this.synthesizeKlatt();
                    
                    // Reproducir el buffer
                    const sourceNode = this.audioContext.createBufferSource();
                    sourceNode.buffer = audioBuffer;
                    sourceNode.connect(this.audioContext.destination);
                    
                    sourceNode.start();
                    this.currentSource = sourceNode;
                    
                    this.isPlaying = true;
                    this.updatePlayButtons('‚è∏ Pausar');
                    this.showMessage('S√≠ntesis Klatt reproduciendo', 'success');
                    
                    // Auto-detener cuando termine
                    sourceNode.onended = () => {
                        this.isPlaying = false;
                        this.updatePlayButtons('‚ñ∂ Reproducir');
                    };
                    
                } catch (error) {
                    console.error('Error en s√≠ntesis Klatt:', error);
                    this.showMessage('Error en s√≠ntesis: ' + error.message, 'error');
                }
            }

            updatePlayButtons(text) {
                document.getElementById('play-button-vowels').textContent = text;
                document.getElementById('play-button-general').textContent = text;
                document.getElementById('play-button-code').textContent = text;
            }

            stopSound() {
                if (this.currentSource) {
                    this.currentSource.stop();
                    this.currentSource = null;
                }
                
                this.isPlaying = false;
                this.updatePlayButtons('‚ñ∂ Reproducir');
            }

            resetToDefaults(tab) {
                // Restaurar par√°metros por defecto
                this.params = { ...this.defaultParams };
                this.timeSequence = null;
                
                // Actualizar interfaz
                this.updateAllSliders();
                this.drawSpectrum();
                
                this.showMessage(`Configuraci√≥n ${tab} restablecida a valores por defecto`, 'success');
            }

            setVowelPreset(vowel) {
                // Valores basados en la imagen proporcionada y c√≥digo de ejemplo
                const vowelData = {
                    'i': { F1: 313, F2: 2200, F3: 2960, B1: 45, B2: 200, B3: 400 },
                    'e': { F1: 457, F2: 1926, F3: 2500, B1: 60, B2: 90, B3: 200 },
                    'a': { F1: 699, F2: 1471, F3: 2500, B1: 60, B2: 70, B3: 160 },
                    'o': { F1: 495, F2: 1070, F3: 2300, B1: 80, B2: 70, B3: 70 },
                    'u': { F1: 349, F2: 877, F3: 2200, B1: 65, B2: 110, B3: 140 }
                };
                
                const data = vowelData[vowel];
                if (!data) return;
                
                // Aplicar valores de la vocal
                Object.keys(data).forEach(param => {
                    this.params[param] = data[param];
                });
                
                // Mantener valores del c√≥digo de ejemplo para F4, F5
                this.params.F4 = 3500;
                this.params.B4 = 150;
                this.params.F5 = 4500;
                this.params.B5 = 200;
                this.params.F0 = 140;
                this.params.AV = 70;
                
                // Actualizar interfaz
                this.updateAllSliders();
                this.drawSpectrum();
                
                this.showMessage(`Vocal /${vowel}/ configurada`, 'success');
            }

            initializeControls() {
                // Configurar todos los sliders
                this.setupSliderGroup('', ['f0', 'av', 'f1', 'f2', 'f3', 'f4', 'f5', 'b1', 'b2', 'b3', 'b4', 'b5', 'duration']);
                this.setupSliderGroup('gen-', [
                    'av', 'af', 'ah', 'avs', 'f0', 'f1', 'f2', 'f3', 'f4', 'f5', 'f6',
                    'b1', 'b2', 'b3', 'b4', 'b5', 'b6', 'a1', 'a2', 'a3', 'a4', 'a5', 'a6',
                    'ab', 'an', 'fgp', 'bgp', 'fgz', 'bgz', 'bgs', 'fnz', 'fnp', 'bnp', 'bnz',
                    'sw', 'nws', 'go', 'nfc', 'duration'
                ]);
                
                // Sample rate selector
                const sampleRateSelect = document.getElementById('gen-sr-select');
                if (sampleRateSelect) {
                    sampleRateSelect.addEventListener('change', (e) => {
                        this.params.SR = parseInt(e.target.value);
                        this.audioContext = null; // Force recreate
                        document.getElementById('gen-sr-value').textContent = this.params.SR + ' Hz';
                        this.drawSpectrum();
                    });
                }
            }

            setupSliderGroup(prefix, paramNames) {
                paramNames.forEach(param => {
                    this.setupSlider(prefix + param, this.getParamName(param));
                });
            }

            getParamName(param) {
                const paramMap = {
                    'f0': 'F0', 'av': 'AV', 'af': 'AF', 'ah': 'AH', 'avs': 'AVS',
                    'f1': 'F1', 'f2': 'F2', 'f3': 'F3', 'f4': 'F4', 'f5': 'F5', 'f6': 'F6',
                    'b1': 'B1', 'b2': 'B2', 'b3': 'B3', 'b4': 'B4', 'b5': 'B5', 'b6': 'B6',
                    'a1': 'A1', 'a2': 'A2', 'a3': 'A3', 'a4': 'A4', 'a5': 'A5', 'a6': 'A6',
                    'ab': 'AB', 'an': 'AN', 'fgp': 'FGP', 'bgp': 'BGP', 'fgz': 'FGZ', 'bgz': 'BGZ',
                    'bgs': 'BGS', 'fnz': 'FNZ', 'fnp': 'FNP', 'bnp': 'BNP', 'bnz': 'BNZ',
                    'sw': 'SW', 'nws': 'NWS', 'go': 'GO', 'nfc': 'NFC', 'duration': 'duration'
                };
                return paramMap[param] || param.toUpperCase();
            }

            setupSlider(sliderId, paramName) {
                const slider = document.getElementById(sliderId + '-slider');
                const valueDisplay = document.getElementById(sliderId + '-value');
                
                if (slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.params[paramName] = value;
                        
                        if (paramName === 'duration') {
                            valueDisplay.textContent = value.toFixed(1);
                        } else {
                            valueDisplay.textContent = value;
                        }
                        
                        this.drawSpectrum();
                    });
                }
            }

            updateAllSliders() {
                const allParams = [
                    'f0', 'av', 'af', 'ah', 'avs', 'f1', 'f2', 'f3', 'f4', 'f5', 'f6',
                    'b1', 'b2', 'b3', 'b4', 'b5', 'b6', 'a1', 'a2', 'a3', 'a4', 'a5', 'a6',
                    'ab', 'an', 'fgp', 'bgp', 'fgz', 'bgz', 'bgs', 'fnz', 'fnp', 'bnp', 'bnz',
                    'sw', 'nws', 'go', 'nfc', 'duration'
                ];
                
                allParams.forEach(param => {
                    const value = this.params[this.getParamName(param)];
                    if (value !== undefined) {
                        this.updateSlider(param, value);
                        this.updateSlider('gen-' + param, value);
                    }
                });
            }

            updateSlider(sliderId, value) {
                const slider = document.getElementById(sliderId + '-slider');
                const valueDisplay = document.getElementById(sliderId + '-value');
                
                if (slider && valueDisplay) {
                    slider.value = value;
                    if (sliderId.includes('duration')) {
                        valueDisplay.textContent = value.toFixed(1);
                    } else {
                        valueDisplay.textContent = value;
                    }
                }
            }

            drawSpectrum() {
                const canvas = document.getElementById('spectrum');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const width = canvas.width;
                const height = canvas.height;
                
                // M√°rgenes para t√≠tulos y etiquetas
                const margin = { top: 60, right: 40, bottom: 60, left: 80 };
                const plotWidth = width - margin.left - margin.right;
                const plotHeight = height - margin.top - margin.bottom;
                
                ctx.clearRect(0, 0, width, height);
                
                // T√≠tulo principal (m√°s arriba para no solaparse)
                ctx.fillStyle = '#333';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Respuesta en Frecuencia - Configuraci√≥n Cascada Klatt 1980', width/2, 25);
                
                // T√≠tulo eje Y (rotado)
                ctx.save();
                ctx.translate(25, height/2);
                ctx.rotate(-Math.PI/2);
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Amplitud (dB)', 0, 0);
                ctx.restore();
                
                // T√≠tulo eje X
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Frecuencia (Hz)', width/2, height - 10);
                
                // √Årea de dibujo del gr√°fico
                const plotX = margin.left;
                const plotY = margin.top;
                
                // Fondo del gr√°fico
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(plotX, plotY, plotWidth, plotHeight);
                
                // Dibujar grid mejorado
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                
                const maxFreq = Math.min(this.params.SR / 2, 5000);
                const freqStep = 500;
                
                // Grid vertical (frecuencias)
                for (let freq = 0; freq <= maxFreq; freq += freqStep) {
                    const x = plotX + (freq / maxFreq) * plotWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, plotY);
                    ctx.lineTo(x, plotY + plotHeight);
                    ctx.stroke();
                    
                    // Etiquetas del eje X
                    ctx.fillStyle = '#666';
                    ctx.font = '11px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(freq.toString(), x, plotY + plotHeight + 20);
                }
                
                // Grid horizontal (dB)
                const dbStep = 10;
                for (let db = -40; db <= 20; db += dbStep) {
                    const normalizedDB = (db + 40) / 60;
                    const y = plotY + plotHeight - (normalizedDB * plotHeight);
                    
                    ctx.strokeStyle = db === 0 ? '#aaa' : '#e0e0e0';
                    ctx.lineWidth = db === 0 ? 2 : 1;
                    ctx.beginPath();
                    ctx.moveTo(plotX, y);
                    ctx.lineTo(plotX + plotWidth, y);
                    ctx.stroke();
                    
                    // Etiquetas del eje Y
                    ctx.fillStyle = '#666';
                    ctx.font = '11px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText(db.toString(), plotX - 10, y + 4);
                }
                
                // Calcular y dibujar respuesta real de formantes usando resonadores
                const tempResonators = [
                    new KlattDigitalResonator(this.params.F1, this.params.B1, this.params.SR),
                    new KlattDigitalResonator(this.params.F2, this.params.B2, this.params.SR),
                    new KlattDigitalResonator(this.params.F3, this.params.B3, this.params.SR),
                    new KlattDigitalResonator(this.params.F4, this.params.B4, this.params.SR),
                    new KlattDigitalResonator(this.params.F5, this.params.B5, this.params.SR)
                ];
                
                // Dibujar respuesta combinada
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                const points = 2000;
                for (let i = 0; i < points; i++) {
                    const freq = (i / points) * maxFreq;
                    const x = plotX + (freq / maxFreq) * plotWidth;
                    
                    // Calcular respuesta combinada real usando ecuaciones de resonadores
                    let totalResponse = 1;
                    tempResonators.forEach(resonator => {
                        if (resonator.frequency > 0) {
                            totalResponse *= resonator.getFrequencyResponse(freq);
                        }
                    });
                    
                    // Agregar efecto de radiaci√≥n (+6dB/octave)
                    const radiationFactor = freq / 1000;
                    totalResponse *= (1 + radiationFactor * 0.5);
                    
                    const dB = 20 * Math.log10(Math.abs(totalResponse) + 0.001);
                    const normalizedDB = Math.max(0, Math.min(1, (dB + 40) / 60));
                    const y = plotY + plotHeight - (normalizedDB * plotHeight);
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
                
                // Marcadores de formantes mejorados
                const formants = [
                    { freq: this.params.F1, label: 'F1', color: '#E91E63' },
                    { freq: this.params.F2, label: 'F2', color: '#9C27B0' },
                    { freq: this.params.F3, label: 'F3', color: '#3F51B5' },
                    { freq: this.params.F4, label: 'F4', color: '#2196F3' },
                    { freq: this.params.F5, label: 'F5', color: '#00BCD4' }
                ];
                
                formants.forEach(({ freq, label, color }) => {
                    if (freq > 0 && freq <= maxFreq) {
                        const x = plotX + (freq / maxFreq) * plotWidth;
                        
                        // L√≠nea del formante
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(x, plotY);
                        ctx.lineTo(x, plotY + plotHeight);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Etiqueta del formante (posicionada dentro del √°rea del gr√°fico)
                        ctx.fillStyle = color;
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x, plotY + 20);
                        
                        // Frecuencia
                        ctx.font = '10px Arial';
                        ctx.fillText(freq + 'Hz', x, plotY + 35);
                    }
                });
                
                // Bordes del gr√°fico
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(plotX, plotY, plotWidth, plotHeight);
            }

            async downloadWAV() {
                try {
                    this.showMessage('Generando archivo WAV...', 'success');
                    
                    const audioBuffer = await this.synthesizeKlatt();
                    const wav = this.audioBufferToWav(audioBuffer);
                    const blob = new Blob([wav], { type: 'audio/wav' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `klatt_synthesis_${this.params.SR}Hz_${Date.now()}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage('Archivo WAV descargado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error descargando WAV:', error);
                    this.showMessage('Error descargando WAV: ' + error.message, 'error');
                }
            }

            audioBufferToWav(buffer) {
                const length = buffer.length;
                const sampleRate = buffer.sampleRate;
                const arrayBuffer = new ArrayBuffer(44 + length * 2);
                const view = new DataView(arrayBuffer);
                
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, length * 2, true);
                
                const channelData = buffer.getChannelData(0);
                let offset = 44;
                for (let i = 0; i < length; i++) {
                    const sample = Math.max(-1, Math.min(1, channelData[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
                
                return arrayBuffer;
            }
        }

        // Variables globales
        let synthesizer;

        // Funciones de cambio de pesta√±as
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', () => {
            synthesizer = new KlattSynthesizer();
        });

        // Funciones de control
        async function toggleSound() {
            if (!synthesizer.isPlaying) {
                await synthesizer.startSound();
            } else {
                synthesizer.stopSound();
            }
        }

        function stopSound() {
            synthesizer.stopSound();
        }

        function setVowel(vowel) {
            synthesizer.setVowelPreset(vowel);
        }

        function resetToDefaults(tab) {
            synthesizer.resetToDefaults(tab);
        }

        async function downloadWAV() {
            await synthesizer.downloadWAV();
        }

        function parseAndSynthesize() {
            const code = document.getElementById('code-textarea').value;
            if (!code.trim()) {
                synthesizer.showMessage('Por favor, introduce c√≥digo de s√≠ntesis', 'error');
                return;
            }
            
            try {
                synthesizer.timeSequence = synthesizer.parseTimeCode(code);
                synthesizer.showMessage(`C√≥digo parseado: ${synthesizer.timeSequence.length} eventos`, 'success');
                console.log('Secuencia temporal:', synthesizer.timeSequence);
            } catch (error) {
                synthesizer.showMessage('Error parseando c√≥digo: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        function loadExampleCode() {
            const exampleCode = `TIME=000; AV=0
TIME +50; F0=140; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +250; F0=110; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +50; AV=0`;
            
            document.getElementById('code-textarea').value = exampleCode;
            synthesizer.showMessage('C√≥digo de ejemplo cargado', 'success');
        }

        function clearCode() {
            document.getElementById('code-textarea').value = '';
            synthesizer.timeSequence = null;
            synthesizer.showMessage('C√≥digo limpiado', 'success');
        }

        // Redimensionamiento de canvas
        window.addEventListener('resize', () => {
            if (synthesizer) {
                synthesizer.drawSpectrum();
            }
        });
    </script>
</body>
</html>
