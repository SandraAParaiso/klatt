<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintetizador de Formantes Klatt (1980)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .synthesis-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .control-group:hover {
            transform: translateY(-3px);
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            appearance: none;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .play-controls {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .play-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            font-weight: 600;
        }

        .play-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.6);
        }

        .play-button.stop {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .play-button.download {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.4);
        }

        .play-button.reset {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .vowel-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .vowel-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
            min-width: 80px;
        }

        .vowel-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .spectrum-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .spectrum-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
        }

        #spectrum {
            width: 100%;
            height: 250px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
        }

        .info-section {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #2196f3;
        }

        .info-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .info-section p {
            line-height: 1.6;
            color: #424242;
            margin-bottom: 10px;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .code-input-section {
            background: #fff3cd;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #ffc107;
        }

        .code-input-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .code-textarea {
            width: 100%;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .code-button {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .vowel-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }

            .play-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sintetizador de Formantes Klatt</h1>
            <p>Software for a cascade/parallel formant synthesizer (1980)</p>
        </div>
        
        <div class="main-content">
            <div id="status-message" class="status-message" style="display: none;"></div>
            
            <div class="synthesis-tabs">
                <button class="tab-button active" onclick="switchTab('vowels')">Síntesis de Vocales</button>
                <button class="tab-button" onclick="switchTab('general')">Síntesis General (39 Parámetros)</button>
                <button class="tab-button" onclick="switchTab('code')">Código TIME</button>
            </div>

            <!-- Tab de Vocales -->
            <div id="vowels-tab" class="tab-content active">
                <div class="vowel-buttons">
                    <button class="vowel-button" onclick="setVowel('a')">/a/</button>
                    <button class="vowel-button" onclick="setVowel('e')">/e/</button>
                    <button class="vowel-button" onclick="setVowel('i')">/i/</button>
                    <button class="vowel-button" onclick="setVowel('o')">/o/</button>
                    <button class="vowel-button" onclick="setVowel('u')">/u/</button>
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Fuente Glotal</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F0 - Frecuencia Fundamental (Hz)</span>
                                <span id="vowel-f0-value">140</span>
                            </div>
                            <input type="range" id="vowel-f0-slider" class="slider" min="80" max="400" value="140" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AV - Amplitud Sonoridad (dB)</span>
                                <span id="vowel-av-value">70</span>
                            </div>
                            <input type="range" id="vowel-av-slider" class="slider" min="0" max="80" value="70" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formantes (Cascada)</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F1 (Hz)</span>
                                <span id="vowel-f1-value">699</span>
                            </div>
                            <input type="range" id="vowel-f1-slider" class="slider" min="150" max="900" value="699" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F2 (Hz)</span>
                                <span id="vowel-f2-value">1471</span>
                            </div>
                            <input type="range" id="vowel-f2-slider" class="slider" min="500" max="2500" value="1471" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F3 (Hz)</span>
                                <span id="vowel-f3-value">2500</span>
                            </div>
                            <input type="range" id="vowel-f3-slider" class="slider" min="1300" max="3500" value="2500" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F4 (Hz)</span>
                                <span id="vowel-f4-value">3500</span>
                            </div>
                            <input type="range" id="vowel-f4-slider" class="slider" min="2500" max="4500" value="3500" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F5 (Hz)</span>
                                <span id="vowel-f5-value">4500</span>
                            </div>
                            <input type="range" id="vowel-f5-slider" class="slider" min="3500" max="4900" value="4500" step="10">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Anchos de Banda</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B1 (Hz)</span>
                                <span id="vowel-b1-value">60</span>
                            </div>
                            <input type="range" id="vowel-b1-slider" class="slider" min="40" max="500" value="60" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B2 (Hz)</span>
                                <span id="vowel-b2-value">70</span>
                            </div>
                            <input type="range" id="vowel-b2-slider" class="slider" min="40" max="500" value="70" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B3 (Hz)</span>
                                <span id="vowel-b3-value">160</span>
                            </div>
                            <input type="range" id="vowel-b3-slider" class="slider" min="40" max="500" value="160" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B4 (Hz)</span>
                                <span id="vowel-b4-value">150</span>
                            </div>
                            <input type="range" id="vowel-b4-slider" class="slider" min="100" max="500" value="150" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B5 (Hz)</span>
                                <span id="vowel-b5-value">200</span>
                            </div>
                            <input type="range" id="vowel-b5-slider" class="slider" min="150" max="700" value="200" step="5">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Control de Sistema</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Duración (segundos)</span>
                                <span id="vowel-duration-value">0.3</span>
                            </div>
                            <input type="range" id="vowel-duration-slider" class="slider" min="0.1" max="2.0" value="0.3" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="play-controls">
                    <button class="play-button" id="play-button-vowels" onclick="toggleSound()">▶ Reproducir</button>
                    <button class="play-button stop" onclick="stopSound()">⏹ Detener</button>
                    <button class="play-button reset" onclick="resetToDefaults('vowels')">🔄 Resetear</button>
                    <button class="play-button download" onclick="downloadWAV()">💾 Descargar WAV</button>
                </div>
            </div>

            <!-- Tab General con 39 parámetros -->
            <div id="general-tab" class="tab-content">
                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Fuentes de Sonido</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AV - Amplitud Sonoridad (dB)</span>
                                <span id="gen-av-value">0</span>
                            </div>
                            <input type="range" id="gen-av-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AF - Amplitud Fricación (dB)</span>
                                <span id="gen-af-value">0</span>
                            </div>
                            <input type="range" id="gen-af-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AH - Amplitud Aspiración (dB)</span>
                                <span id="gen-ah-value">0</span>
                            </div>
                            <input type="range" id="gen-ah-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AVS - Amplitud Sonoridad Sinusoidal (dB)</span>
                                <span id="gen-avs-value">0</span>
                            </div>
                            <input type="range" id="gen-avs-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F0 - Frecuencia Fundamental (Hz)</span>
                                <span id="gen-f0-value">0</span>
                            </div>
                            <input type="range" id="gen-f0-slider" class="slider" min="0" max="500" value="0" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Frecuencias de Formantes</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F1 - Primer Formante (Hz)</span>
                                <span id="gen-f1-value">450</span>
                            </div>
                            <input type="range" id="gen-f1-slider" class="slider" min="150" max="900" value="450" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F2 - Segundo Formante (Hz)</span>
                                <span id="gen-f2-value">1450</span>
                            </div>
                            <input type="range" id="gen-f2-slider" class="slider" min="500" max="2500" value="1450" step="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F3 - Tercer Formante (Hz)</span>
                                <span id="gen-f3-value">2450</span>
                            </div>
                            <input type="range" id="gen-f3-slider" class="slider" min="1300" max="3500" value="2450" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F4 - Cuarto Formante (Hz)</span>
                                <span id="gen-f4-value">3300</span>
                            </div>
                            <input type="range" id="gen-f4-slider" class="slider" min="2500" max="4500" value="3300" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F5 - Quinto Formante (Hz)</span>
                                <span id="gen-f5-value">3750</span>
                            </div>
                            <input type="range" id="gen-f5-slider" class="slider" min="3500" max="4900" value="3750" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>F6 - Sexto Formante (Hz)</span>
                                <span id="gen-f6-value">4900</span>
                            </div>
                            <input type="range" id="gen-f6-slider" class="slider" min="4000" max="4999" value="4900" step="10">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Anchos de Banda de Formantes</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B1 - Ancho Primer Formante (Hz)</span>
                                <span id="gen-b1-value">50</span>
                            </div>
                            <input type="range" id="gen-b1-slider" class="slider" min="40" max="500" value="50" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B2 - Ancho Segundo Formante (Hz)</span>
                                <span id="gen-b2-value">70</span>
                            </div>
                            <input type="range" id="gen-b2-slider" class="slider" min="40" max="500" value="70" step="5">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B3 - Ancho Tercer Formante (Hz)</span>
                                <span id="gen-b3-value">110</span>
                            </div>
                            <input type="range" id="gen-b3-slider" class="slider" min="40" max="500" value="110" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B4 - Ancho Cuarto Formante (Hz)</span>
                                <span id="gen-b4-value">250</span>
                            </div>
                            <input type="range" id="gen-b4-slider" class="slider" min="100" max="500" value="250" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B5 - Ancho Quinto Formante (Hz)</span>
                                <span id="gen-b5-value">200</span>
                            </div>
                            <input type="range" id="gen-b5-slider" class="slider" min="150" max="700" value="200" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>B6 - Ancho Sexto Formante (Hz)</span>
                                <span id="gen-b6-value">1000</span>
                            </div>
                            <input type="range" id="gen-b6-slider" class="slider" min="200" max="2000" value="1000" step="50">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Formante Nasal</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FNZ - Frecuencia Cero Nasal (Hz)</span>
                                <span id="gen-fnz-value">250</span>
                            </div>
                            <input type="range" id="gen-fnz-slider" class="slider" min="200" max="700" value="250" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FNP - Frecuencia Polo Nasal (Hz)</span>
                                <span id="gen-fnp-value">250</span>
                            </div>
                            <input type="range" id="gen-fnp-slider" class="slider" min="200" max="500" value="250" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BNP - Ancho Polo Nasal (Hz)</span>
                                <span id="gen-bnp-value">100</span>
                            </div>
                            <input type="range" id="gen-bnp-slider" class="slider" min="50" max="500" value="100" step="5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BNZ - Ancho Cero Nasal (Hz)</span>
                                <span id="gen-bnz-value">100</span>
                            </div>
                            <input type="range" id="gen-bnz-slider" class="slider" min="50" max="500" value="100" step="5">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Amplitudes Paralelas</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AN - Amplitud Formante Nasal (dB)</span>
                                <span id="gen-an-value">0</span>
                            </div>
                            <input type="range" id="gen-an-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A1 - Amplitud Primer Formante (dB)</span>
                                <span id="gen-a1-value">0</span>
                            </div>
                            <input type="range" id="gen-a1-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A2 - Amplitud Segundo Formante (dB)</span>
                                <span id="gen-a2-value">0</span>
                            </div>
                            <input type="range" id="gen-a2-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A3 - Amplitud Tercer Formante (dB)</span>
                                <span id="gen-a3-value">0</span>
                            </div>
                            <input type="range" id="gen-a3-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A4 - Amplitud Cuarto Formante (dB)</span>
                                <span id="gen-a4-value">0</span>
                            </div>
                            <input type="range" id="gen-a4-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A5 - Amplitud Quinto Formante (dB)</span>
                                <span id="gen-a5-value">0</span>
                            </div>
                            <input type="range" id="gen-a5-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>A6 - Amplitud Sexto Formante (dB)</span>
                                <span id="gen-a6-value">0</span>
                            </div>
                            <input type="range" id="gen-a6-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>AB - Amplitud Bypass (dB)</span>
                                <span id="gen-ab-value">0</span>
                            </div>
                            <input type="range" id="gen-ab-slider" class="slider" min="0" max="80" value="0" step="1">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Resonadores Glotales</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FGP - Frecuencia Resonador Glotal 1 (Hz)</span>
                                <span id="gen-fgp-value">0</span>
                            </div>
                            <input type="range" id="gen-fgp-slider" class="slider" min="0" max="600" value="0" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BGP - Ancho Resonador Glotal 1 (Hz)</span>
                                <span id="gen-bgp-value">100</span>
                            </div>
                            <input type="range" id="gen-bgp-slider" class="slider" min="100" max="2000" value="100" step="10">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>FGZ - Frecuencia Cero Glotal (Hz)</span>
                                <span id="gen-fgz-value">1500</span>
                            </div>
                            <input type="range" id="gen-fgz-slider" class="slider" min="0" max="5000" value="1500" step="50">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BGZ - Ancho Cero Glotal (Hz)</span>
                                <span id="gen-bgz-value">6000</span>
                            </div>
                            <input type="range" id="gen-bgz-slider" class="slider" min="100" max="9000" value="6000" step="100">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>BGS - Ancho Resonador Glotal 2 (Hz)</span>
                                <span id="gen-bgs-value">200</span>
                            </div>
                            <input type="range" id="gen-bgs-slider" class="slider" min="100" max="1000" value="200" step="10">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Control del Sistema</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>SW - Cascada/Paralelo (0=Cascada, 1=Paralelo)</span>
                                <span id="gen-sw-value">0</span>
                            </div>
                            <input type="range" id="gen-sw-slider" class="slider" min="0" max="1" value="0" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>SR - Frecuencia de Muestreo (Hz)</span>
                                <span id="gen-sr-value">10000</span>
                            </div>
                            <select id="gen-sr-select" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="10000">10000 Hz (Original Paper)</option>
                                <option value="22050">22050 Hz</option>
                                <option value="44100">44100 Hz</option>
                            </select>
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>NWS - Muestras por Chunk</span>
                                <span id="gen-nws-value">50</span>
                            </div>
                            <input type="range" id="gen-nws-slider" class="slider" min="1" max="200" value="50" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>GO - Control de Ganancia (dB)</span>
                                <span id="gen-go-value">47</span>
                            </div>
                            <input type="range" id="gen-go-slider" class="slider" min="0" max="80" value="47" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>NFC - Número de Formantes en Cascada</span>
                                <span id="gen-nfc-value">5</span>
                            </div>
                            <input type="range" id="gen-nfc-slider" class="slider" min="4" max="6" value="5" step="1">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Duración (segundos)</span>
                                <span id="gen-duration-value">2.0</span>
                            </div>
                            <input type="range" id="gen-duration-slider" class="slider" min="0.1" max="5.0" value="2.0" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="play-controls">
                    <button class="play-button" id="play-button-general" onclick="toggleSound()">▶ Reproducir</button>
                    <button class="play-button stop" onclick="stopSound()">⏹ Detener</button>
                    <button class="play-button reset" onclick="resetToDefaults('general')">🔄 Resetear</button>
                    <button class="play-button download" onclick="downloadWAV()">💾 Descargar WAV</button>
                </div>
            </div>

            <!-- Tab Código TIME -->
            <div id="code-tab" class="tab-content">
                <div class="code-input-section">
                    <h3>Generación de Estímulos con Código TIME</h3>
                    <p style="margin-bottom: 15px;">Introduce un código en formato TIME para generar estímulos complejos. Ejemplo:</p>
                    <textarea id="time-code-input" class="code-textarea" placeholder="TIME=000; AV=0
TIME +50; F0=140; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +250; F0=110; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +50; AV=0">TIME=000; AV=0
TIME +50; F0=140; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +250; F0=110; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +50; AV=0</textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="code-button" onclick="parseTimeCode()">🎵 Generar Estímulo</button>
                        <button class="code-button" onclick="loadExampleCode()">📝 Cargar Ejemplo</button>
                        <button class="code-button" onclick="clearTimeCode()">🗑️ Limpiar</button>
                    </div>
                </div>

                <div class="play-controls">
                    <button class="play-button" id="play-button-code" onclick="toggleSound()">▶ Reproducir</button>
                    <button class="play-button stop" onclick="stopSound()">⏹ Detener</button>
                    <button class="play-button download" onclick="downloadWAV()">💾 Descargar WAV</button>
                </div>
            </div>

            <div class="spectrum-container">
                <h3>Respuesta de Formantes (Implementación Klatt 1980)</h3>
                <canvas id="spectrum"></canvas>
            </div>

            <div class="info-section">
                <h3>Implementación Exacta del Paper Klatt (1980)</h3>
                <p>
                    Esta implementación replica exactamente los 39 parámetros de control descritos en el paper original:
                </p>
                <p>
                    <strong>• Resonadores Digitales:</strong> Ecuaciones de diferencia de segundo orden con transformación impulse-invariant
                </p>
                <p>
                    <strong>• Configuración Cascada:</strong> Fuente Glotal → RGP → F1 → F2 → F3 → F4 → F5 → Radiación
                </p>
                <p>
                    <strong>• 39 Parámetros de Control:</strong> Como se especifica en la Tabla I del paper original
                </p>
                <p>
                    <strong>• Filtro de Radiación:</strong> Diferencia primera para simular radiación desde los labios
                </p>
                <p>
                    <strong>• Frecuencia de Muestreo:</strong> 10,000 Hz (como en el paper original)
                </p>
            </div>
        </div>
    </div>

    <script>
        // Implementación exacta del sintetizador Klatt (1980)
        class KlattDigitalResonator {
            constructor(frequency, bandwidth, sampleRate) {
                this.frequency = frequency;
                this.bandwidth = bandwidth;
                this.sampleRate = sampleRate;
                
                // Estados del resonador
                this.y1 = 0;
                this.y2 = 0;
                
                this.calculateCoefficients();
            }
            
            calculateCoefficients() {
                // Implementación exacta de las ecuaciones del paper Klatt (1980)
                const T = 1.0 / this.sampleRate;
                const PI = Math.PI;
                
                if (this.frequency <= 0) {
                    // Resonador paso-bajo cuando F = 0
                    this.C = -Math.exp(-2 * PI * this.bandwidth * T);
                    this.B = 0;
                    this.A = 1 - this.B - this.C;
                } else {
                    // Resonador normal
                    this.C = -Math.exp(-2 * PI * this.bandwidth * T);
                    this.B = 2 * Math.exp(-PI * this.bandwidth * T) * Math.cos(2 * PI * this.frequency * T);
                    this.A = 1 - this.B - this.C;
                }
            }
            
            process(input) {
                // Ecuación (1) del paper: y(nT) = Ax(nT) + By(nT-T) + Cy(nT-2T)
                const output = this.A * input + this.B * this.y1 + this.C * this.y2;
                
                // Actualizar estados
                this.y2 = this.y1;
                this.y1 = output;
                
                return output;
            }
            
            reset() {
                this.y1 = 0;
                this.y2 = 0;
            }
        }

        // Sintetizador principal siguiendo exactamente el paper
        class KlattSynthesizer {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.currentSource = null;
                
                // Parámetros por defecto según Tabla I del paper (los 39 parámetros)
                this.defaultParams = {
                    // Fuentes de sonido
                    AV: 0,      // Amplitude of voicing
                    AF: 0,      // Amplitude of frication
                    AH: 0,      // Amplitude of aspiration
                    AVS: 0,     // Amplitude of quasi-sinusoidal voicing
                    F0: 0,      // Fundamental frequency
                    
                    // Frecuencias de formantes
                    F1: 450,    // First formant frequency
                    F2: 1450,   // Second formant frequency
                    F3: 2450,   // Third formant frequency
                    F4: 3300,   // Fourth formant frequency
                    F5: 3750,   // Fifth formant frequency
                    F6: 4900,   // Sixth formant frequency
                    
                    // Formante nasal
                    FNZ: 250,   // Nasal zero frequency
                    FNP: 250,   // Nasal pole frequency
                    
                    // Amplitudes paralelas
                    AN: 0,      // Nasal formant amplitude
                    A1: 0,      // First formant amplitude
                    A2: 0,      // Second formant amplitude
                    A3: 0,      // Third formant amplitude
                    A4: 0,      // Fourth formant amplitude
                    A5: 0,      // Fifth formant amplitude
                    A6: 0,      // Sixth formant amplitude
                    AB: 0,      // Bypass path amplitude
                    
                    // Anchos de banda
                    B1: 50,     // First formant bandwidth
                    B2: 70,     // Second formant bandwidth
                    B3: 110,    // Third formant bandwidth
                    B4: 250,    // Fourth formant bandwidth
                    B5: 200,    // Fifth formant bandwidth
                    B6: 1000,   // Sixth formant bandwidth
                    BNP: 100,   // Nasal pole bandwidth
                    BNZ: 100,   // Nasal zero bandwidth
                    
                    // Resonadores glotales
                    FGP: 0,     // Glottal resonator 1 frequency
                    BGP: 100,   // Glottal resonator 1 bandwidth
                    FGZ: 1500,  // Glottal zero frequency
                    BGZ: 6000,  // Glottal zero bandwidth
                    BGS: 200,   // Glottal resonator 2 bandwidth
                    
                    // Control de sistema
                    SW: 0,      // Cascade/parallel switch
                    SR: 10000,  // Sampling rate
                    NWS: 50,    // Number of waveform samples per chunk
                    GO: 47,     // Overall gain control
                    NFC: 5,     // Number of cascaded formants
                    
                    duration: 2.0
                };
                
                this.params = { ...this.defaultParams };
                this.timeCodeData = null;
                
                this.initializeControls();
                this.drawSpectrum();
                this.showMessage('Sintetizador Klatt (1980) inicializado', 'success');
            }

            showMessage(text, type = 'success') {
                const messageDiv = document.getElementById('status-message');
                messageDiv.textContent = text;
                messageDiv.className = `status-message ${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            async initializeAudio() {
                if (!this.audioContext) {
                    this.audioContext = new AudioContext({ sampleRate: this.params.SR });
                    console.log('AudioContext creado con sample rate:', this.audioContext.sampleRate);
                }
                
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
                
                return true;
            }

            generateGlottalSource(n, samplesPerPeriod) {
                // Generar tren de impulsos glotal según paper Klatt
                if (this.params.F0 <= 0 || this.params.AV <= 0) return 0;
                
                // Un impulso cada período fundamental
                if (samplesPerPeriod > 0 && n % Math.floor(samplesPerPeriod) === 0) {
                    // Amplitud del impulso basada en AV (dB)
                    return this.dbToLinear(this.params.AV - 60);
                }
                return 0;
            }

            generateNoise() {
                // Generador de ruido pseudo-aleatorio
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += Math.random() - 0.5;
                }
                return sum / 6;
            }

            dbToLinear(db) {
                return Math.pow(10, db / 20);
            }

            async synthesizeKlatt() {
                if (this.timeCodeData) {
                    return await this.synthesizeFromTimeCode();
                }
                
                const duration = this.params.duration;
                const sampleRate = this.params.SR;
                const numSamples = Math.floor(duration * sampleRate);
                
                console.log(`Síntesis Klatt: ${numSamples} muestras a ${sampleRate}Hz`);
                
                // Crear resonadores digitales según configuración cascada del paper
                const glottalLPF = new KlattDigitalResonator(0, 100, sampleRate);
                
                // Cascada de formantes según Figure 6 del paper
                const formantResonators = [
                    new KlattDigitalResonator(this.params.F1, this.params.B1, sampleRate),
                    new KlattDigitalResonator(this.params.F2, this.params.B2, sampleRate),
                    new KlattDigitalResonator(this.params.F3, this.params.B3, sampleRate),
                    new KlattDigitalResonator(this.params.F4, this.params.B4, sampleRate),
                    new KlattDigitalResonator(this.params.F5, this.params.B5, sampleRate)
                ];
                
                const audioBuffer = this.audioContext.createBuffer(1, numSamples, sampleRate);
                const outputData = audioBuffer.getChannelData(0);
                
                // Estados para diferencia primera (radiación)
                let prevSample = 0;
                
                // Calcular muestras por período fundamental
                const samplesPerPeriod = this.params.F0 > 0 ? sampleRate / this.params.F0 : 0;
                
                // Síntesis muestra por muestra - algoritmo del paper
                for (let n = 0; n < numSamples; n++) {
                    // 1. Generar fuente glotal
                    let glottalSource = this.generateGlottalSource(n, samplesPerPeriod);
                    
                    // 2. Generar fuentes de ruido
                    let noiseSource = this.generateNoise();
                    let aspiration = 0;
                    let frication = 0;
                    
                    if (this.params.AH > 0) {
                        aspiration = noiseSource * this.dbToLinear(this.params.AH - 60);
                    }
                    
                    if (this.params.AF > 0) {
                        frication = noiseSource * this.dbToLinear(this.params.AF - 60);
                    }
                    
                    // 3. Combinar fuentes para entrada al tracto vocal
                    let vocalTractInput = glottalSource + aspiration;
                    
                    // 4. Filtro paso-bajo glotal
                    let signal = glottalLPF.process(vocalTractInput);
                    
                    // 5. Cascada de resonadores de formantes
                    for (let i = 0; i < Math.min(formantResonators.length, this.params.NFC); i++) {
                        signal = formantResonators[i].process(signal);
                    }
                    
                    // 6. Agregar fricación directa
                    signal += frication;
                    
                    // 7. Filtro de radiación (diferencia primera)
                    const radiatedSignal = signal - prevSample;
                    prevSample = signal;
                    
                    // 8. Almacenar muestra final con ganancia
                    outputData[n] = radiatedSignal * this.dbToLinear(this.params.GO - 60) * 0.1;
                }
                
                console.log('Síntesis completada, máximo nivel:', Math.max(...outputData.map(x => Math.abs(x))));
                return audioBuffer;
            }

            async synthesizeFromTimeCode() {
                if (!this.timeCodeData || this.timeCodeData.length === 0) {
                    throw new Error('No hay datos de código TIME válidos');
                }

                const sampleRate = this.params.SR;
                
                // Calcular duración total
                let totalDuration = 0;
                for (let segment of this.timeCodeData) {
                    totalDuration = Math.max(totalDuration, segment.time + segment.duration);
                }
                
                const numSamples = Math.floor(totalDuration * sampleRate / 1000); // time en ms
                const audioBuffer = this.audioContext.createBuffer(1, numSamples, sampleRate);
                const outputData = audioBuffer.getChannelData(0);
                
                console.log(`Síntesis desde código TIME: ${numSamples} muestras, ${totalDuration}ms`);
                
                // Procesar cada segmento
                for (let segment of this.timeCodeData) {
                    const startSample = Math.floor(segment.time * sampleRate / 1000);
                    const segmentSamples = Math.floor(segment.duration * sampleRate / 1000);
                    
                    // Crear resonadores para este segmento
                    const glottalLPF = new KlattDigitalResonator(0, 100, sampleRate);
                    const formantResonators = [
                        new KlattDigitalResonator(segment.params.F1, segment.params.B1, sampleRate),
                        new KlattDigitalResonator(segment.params.F2, segment.params.B2, sampleRate),
                        new KlattDigitalResonator(segment.params.F3, segment.params.B3, sampleRate),
                        new KlattDigitalResonator(segment.params.F4, segment.params.B4, sampleRate),
                        new KlattDigitalResonator(segment.params.F5, segment.params.B5, sampleRate)
                    ];
                    
                    let prevSample = 0;
                    const samplesPerPeriod = segment.params.F0 > 0 ? sampleRate / segment.params.F0 : 0;
                    
                    for (let n = 0; n < segmentSamples && (startSample + n) < numSamples; n++) {
                        // Generar fuente glotal
                        let glottalSource = 0;
                        if (segment.params.F0 > 0 && segment.params.AV > 0) {
                            if (samplesPerPeriod > 0 && n % Math.floor(samplesPerPeriod) === 0) {
                                glottalSource = this.dbToLinear(segment.params.AV - 60);
                            }
                        }
                        
                        // Procesamiento del tracto vocal
                        let signal = glottalLPF.process(glottalSource);
                        
                        // Cascada de formantes
                        for (let resonator of formantResonators) {
                            signal = resonator.process(signal);
                        }
                        
                        // Filtro de radiación
                        const radiatedSignal = signal - prevSample;
                        prevSample = signal;
                        
                        // Almacenar muestra
                        outputData[startSample + n] = radiatedSignal * 0.1;
                    }
                }
                
                return audioBuffer;
            }

            parseTimeCode(codeText) {
                const lines = codeText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const segments = [];
                let currentTime = 0;
                let currentParams = { ...this.defaultParams };
                
                for (let line of lines) {
                    if (line.startsWith('TIME=')) {
                        // TIME=000 - tiempo absoluto
                        const timeMatch = line.match(/TIME=(\d+)/);
                        if (timeMatch) {
                            currentTime = parseInt(timeMatch[1]);
                        }
                    } else if (line.startsWith('TIME +')) {
                        // TIME +50 - tiempo relativo + parámetros
                        const parts = line.split(';').map(p => p.trim());
                        const timeMatch = parts[0].match(/TIME \+(\d+)/);
                        
                        if (timeMatch) {
                            const duration = parseInt(timeMatch[1]);
                            
                            // Procesar parámetros en esta línea
                            for (let i = 1; i < parts.length; i++) {
                                const paramMatch = parts[i].match(/(\w+)=(\d+(?:\.\d+)?)/);
                                if (paramMatch) {
                                    const paramName = paramMatch[1];
                                    const paramValue = parseFloat(paramMatch[2]);
                                    currentParams[paramName] = paramValue;
                                }
                            }
                            
                            // Crear segmento
                            segments.push({
                                time: currentTime,
                                duration: duration,
                                params: { ...currentParams }
                            });
                            
                            currentTime += duration;
                        }
                    } else {
                        // Línea solo con parámetros
                        const paramMatches = line.match(/(\w+)=(\d+(?:\.\d+)?)/g);
                        if (paramMatches) {
                            for (let paramMatch of paramMatches) {
                                const [paramName, paramValue] = paramMatch.split('=');
                                currentParams[paramName] = parseFloat(paramValue);
                            }
                        }
                    }
                }
                
                this.timeCodeData = segments;
                console.log('Código TIME parseado:', segments);
                return segments;
            }

            async startSound() {
                const success = await this.initializeAudio();
                if (!success) return;
                
                if (this.isPlaying) {
                    this.stopSound();
                }
                
                try {
                    console.log('Iniciando síntesis Klatt con parámetros:', this.params);
                    
                    // Generar audio buffer usando implementación Klatt
                    const audioBuffer = await this.synthesizeKlatt();
                    
                    // Reproducir el buffer
                    const sourceNode = this.audioContext.createBufferSource();
                    sourceNode.buffer = audioBuffer;
                    sourceNode.connect(this.audioContext.destination);
                    
                    sourceNode.start();
                    this.currentSource = sourceNode;
                    
                    this.isPlaying = true;
                    const activeTab = document.querySelector('.tab-content.active').id;
                    let playButton;
                    if (activeTab === 'vowels-tab') playButton = 'play-button-vowels';
                    else if (activeTab === 'general-tab') playButton = 'play-button-general';
                    else playButton = 'play-button-code';
                    
                    document.getElementById(playButton).textContent = '⏸ Pausar';
                    this.showMessage('Síntesis Klatt reproduciendo', 'success');
                    
                    // Auto-detener cuando termine
                    sourceNode.onended = () => {
                        this.isPlaying = false;
                        document.getElementById(playButton).textContent = '▶ Reproducir';
                    };
                    
                } catch (error) {
                    console.error('Error en síntesis Klatt:', error);
                    this.showMessage('Error en síntesis: ' + error.message, 'error');
                }
            }

            stopSound() {
                if (this.currentSource) {
                    this.currentSource.stop();
                    this.currentSource = null;
                }
                
                this.isPlaying = false;
                document.getElementById('play-button-vowels').textContent = '▶ Reproducir';
                document.getElementById('play-button-general').textContent = '▶ Reproducir';
                document.getElementById('play-button-code').textContent = '▶ Reproducir';
            }

            resetToDefaults(tab) {
                this.params = { ...this.defaultParams };
                this.timeCodeData = null;
                
                if (tab === 'vowels') {
                    this.updateVowelSliders();
                } else if (tab === 'general') {
                    this.updateAllGeneralSliders();
                }
                
                this.drawSpectrum();
                this.showMessage(`Configuración ${tab} restablecida a valores por defecto`, 'success');
            }

            async downloadWAV() {
                try {
                    this.showMessage('Generando archivo WAV...', 'success');
                    
                    // Generar audio usando síntesis Klatt
                    const audioBuffer = await this.synthesizeKlatt();
                    
                    // Convertir a WAV
                    const wav = this.audioBufferToWav(audioBuffer);
                    const blob = new Blob([wav], { type: 'audio/wav' });
                    
                    // Descargar
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `klatt_synthesis_${this.params.SR}Hz_${Date.now()}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage('Archivo WAV descargado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error descargando WAV:', error);
                    this.showMessage('Error descargando WAV: ' + error.message, 'error');
                }
            }

            audioBufferToWav(buffer) {
                const length = buffer.length;
                const sampleRate = buffer.sampleRate;
                const arrayBuffer = new ArrayBuffer(44 + length * 2);
                const view = new DataView(arrayBuffer);
                
                // WAV header
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, length * 2, true);
                
                // Convert samples to 16-bit PCM
                const channelData = buffer.getChannelData(0);
                let offset = 44;
                for (let i = 0; i < length; i++) {
                    const sample = Math.max(-1, Math.min(1, channelData[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
                
                return arrayBuffer;
            }

            initializeControls() {
                // Configurar sliders para vocales
                this.setupVowelSliders();
                
                // Configurar sliders para síntesis general (39 parámetros)
                this.setupGeneralSliders();
                
                // Sample rate selector
                const sampleRateSelect = document.getElementById('gen-sr-select');
                if (sampleRateSelect) {
                    sampleRateSelect.addEventListener('change', (e) => {
                        this.params.SR = parseInt(e.target.value);
                        this.audioContext = null;
                        document.getElementById('gen-sr-value').textContent = this.params.SR + ' Hz';
                        this.drawSpectrum();
                    });
                }
            }

            setupVowelSliders() {
                const vowelParams = [
                    'f0', 'av', 'f1', 'f2', 'f3', 'f4', 'f5', 
                    'b1', 'b2', 'b3', 'b4', 'b5', 'duration'
                ];
                
                vowelParams.forEach(param => {
                    this.setupSlider('vowel-' + param, this.getParamName(param));
                });
            }

            setupGeneralSliders() {
                const generalParams = [
                    'av', 'af', 'ah', 'avs', 'f0',
                    'f1', 'f2', 'f3', 'f4', 'f5', 'f6',
                    'b1', 'b2', 'b3', 'b4', 'b5', 'b6',
                    'fnz', 'fnp', 'bnp', 'bnz',
                    'an', 'a1', 'a2', 'a3', 'a4', 'a5', 'a6', 'ab',
                    'fgp', 'bgp', 'fgz', 'bgz', 'bgs',
                    'sw', 'nws', 'go', 'nfc', 'duration'
                ];
                
                generalParams.forEach(param => {
                    this.setupSlider('gen-' + param, this.getParamName(param));
                });
            }

            getParamName(param) {
                const paramMap = {
                    'f0': 'F0', 'av': 'AV', 'af': 'AF', 'ah': 'AH', 'avs': 'AVS',
                    'f1': 'F1', 'f2': 'F2', 'f3': 'F3', 'f4': 'F4', 'f5': 'F5', 'f6': 'F6',
                    'b1': 'B1', 'b2': 'B2', 'b3': 'B3', 'b4': 'B4', 'b5': 'B5', 'b6': 'B6',
                    'fnz': 'FNZ', 'fnp': 'FNP', 'bnp': 'BNP', 'bnz': 'BNZ',
                    'an': 'AN', 'a1': 'A1', 'a2': 'A2', 'a3': 'A3', 'a4': 'A4', 'a5': 'A5', 'a6': 'A6', 'ab': 'AB',
                    'fgp': 'FGP', 'bgp': 'BGP', 'fgz': 'FGZ', 'bgz': 'BGZ', 'bgs': 'BGS',
                    'sw': 'SW', 'sr': 'SR', 'nws': 'NWS', 'go': 'GO', 'nfc': 'NFC',
                    'duration': 'duration'
                };
                return paramMap[param] || param.toUpperCase();
            }

            setupSlider(sliderId, paramName) {
                const slider = document.getElementById(sliderId + '-slider');
                const valueDisplay = document.getElementById(sliderId + '-value');
                
                if (slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.params[paramName] = value;
                        
                        if (paramName === 'duration') {
                            valueDisplay.textContent = value.toFixed(1);
                        } else {
                            valueDisplay.textContent = value;
                        }
                        
                        this.drawSpectrum();
                    });
                }
            }

            updateVowelSliders() {
                const vowelParams = ['F0', 'AV', 'F1', 'F2', 'F3', 'F4', 'F5', 'B1', 'B2', 'B3', 'B4', 'B5', 'duration'];
                vowelParams.forEach(param => {
                    const value = this.params[param];
                    if (value !== undefined) {
                        this.updateSlider('vowel-' + param.toLowerCase(), value);
                    }
                });
            }

            updateAllGeneralSliders() {
                const allParams = Object.keys(this.params);
                allParams.forEach(param => {
                    const value = this.params[param];
                    if (value !== undefined) {
                        this.updateSlider('gen-' + param.toLowerCase(), value);
                    }
                });
            }

            updateSlider(sliderId, value) {
                const slider = document.getElementById(sliderId + '-slider');
                const valueDisplay = document.getElementById(sliderId + '-value');
                
                if (slider && valueDisplay) {
                    slider.value = value;
                    if (sliderId.includes('duration')) {
                        valueDisplay.textContent = value.toFixed(1);
                    } else {
                        valueDisplay.textContent = value;
                    }
                }
            }

            drawSpectrum() {
                const canvas = document.getElementById('spectrum');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const width = canvas.width;
                const height = canvas.height;
                
                ctx.clearRect(0, 0, width, height);
                
                // Dibujar grid
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                const maxFreq = this.params.SR / 2;
                const freqStep = maxFreq / 10;
                
                for (let freq = 0; freq <= maxFreq; freq += freqStep) {
                    const x = (freq / maxFreq) * width;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(Math.round(freq) + 'Hz', x, height - 5);
                }
                
                // Dibujar respuesta teórica según ecuaciones de Klatt
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const points = 1000;
                for (let i = 0; i < points; i++) {
                    const freq = (i / points) * maxFreq;
                    const x = (freq / maxFreq) * width;
                    
                    // Calcular respuesta combinada
                    let response = this.calculateFormantResponse(freq);
                    
                    const dB = 20 * Math.log10(Math.abs(response) + 0.001);
                    const normalizedDB = Math.max(0, Math.min(1, (dB + 40) / 60));
                    const y = height - (normalizedDB * height);
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
                
                // Marcadores de formantes
                ctx.strokeStyle = '#E91E63';
                ctx.lineWidth = 2;
                
                const formants = [
                    { freq: this.params.F1, label: 'F1' },
                    { freq: this.params.F2, label: 'F2' },
                    { freq: this.params.F3, label: 'F3' },
                    { freq: this.params.F4, label: 'F4' },
                    { freq: this.params.F5, label: 'F5' }
                ];
                
                formants.forEach(({ freq, label }) => {
                    if (freq > 0 && freq <= maxFreq) {
                        const x = (freq / maxFreq) * width;
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, height);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#E91E63';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x, 20);
                    }
                });
            }

            calculateFormantResponse(frequency) {
                let response = 1;
                
                const formants = [
                    { f: this.params.F1, bw: this.params.B1 },
                    { f: this.params.F2, bw: this.params.B2 },
                    { f: this.params.F3, bw: this.params.B3 },
                    { f: this.params.F4, bw: this.params.B4 },
                    { f: this.params.F5, bw: this.params.B5 }
                ];
                
                formants.forEach(({ f, bw }) => {
                    if (f > 0) {
                        const q = f / Math.max(bw, 1);
                        const formantResponse = q / (1 + Math.pow(q * (frequency - f) / f, 2));
                        response *= formantResponse;
                    }
                });
                
                return response;
            }

            // Configuraciones de vocales según valores estándar del español
            setVowelPreset(vowel) {
                const vowelData = {
                    'a': { F0: 140, AV: 70, F1: 699, B1: 60, F2: 1471, B2: 70, F3: 2500, B3: 160, F4: 3500, B4: 150, F5: 4500, B5: 200 },
                    'e': { F0: 140, AV: 70, F1: 450, B1: 60, F2: 1800, B2: 70, F3: 2500, B3: 160, F4: 3500, B4: 150, F5: 4500, B5: 200 },
                    'i': { F0: 140, AV: 70, F1: 300, B1: 60, F2: 2200, B2: 70, F3: 2960, B3: 160, F4: 3500, B4: 150, F5: 4500, B5: 200 },
                    'o': { F0: 140, AV: 70, F1: 500, B1: 60, F2: 1000, B2: 70, F3: 2300, B3: 160, F4: 3500, B4: 150, F5: 4500, B5: 200 },
                    'u': { F0: 140, AV: 70, F1: 300, B1: 60, F2: 900, B2: 70, F3: 2200, B3: 160, F4: 3500, B4: 150, F5: 4500, B5: 200 }
                };
                
                const data = vowelData[vowel];
                if (!data) return;
                
                // Aplicar valores
                Object.keys(data).forEach(param => {
                    this.params[param] = data[param];
                });
                
                // Actualizar interfaz
                this.updateVowelSliders();
                this.drawSpectrum();
                
                this.showMessage(`Vocal /${vowel}/ configurada`, 'success');
            }
        }

        // Variables globales
        let synthesizer;

        // Funciones de cambio de pestañas
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Funciones para código TIME
        function parseTimeCode() {
            const codeInput = document.getElementById('time-code-input');
            const codeText = codeInput.value.trim();
            
            if (!codeText) {
                synthesizer.showMessage('Por favor, introduce un código TIME válido', 'error');
                return;
            }
            
            try {
                const segments = synthesizer.parseTimeCode(codeText);
                if (segments.length > 0) {
                    synthesizer.showMessage(`Código parseado: ${segments.length} segmentos`, 'success');
                } else {
                    synthesizer.showMessage('No se encontraron segmentos válidos en el código', 'error');
                }
            } catch (error) {
                synthesizer.showMessage('Error parseando código: ' + error.message, 'error');
            }
        }

        function loadExampleCode() {
            const exampleCode = `TIME=000; AV=0
TIME +50; F0=140; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +250; F0=110; AV=70; F1=699; B1=60; F2=1471; B2=70; F3=2500; B3=160; F4=3500; B4=150; F5=4500; B5=200
TIME +50; AV=0`;
            
            document.getElementById('time-code-input').value = exampleCode;
            synthesizer.showMessage('Código de ejemplo cargado', 'success');
        }

        function clearTimeCode() {
            document.getElementById('time-code-input').value = '';
            synthesizer.timeCodeData = null;
            synthesizer.showMessage('Código TIME limpiado', 'success');
        }

        // Inicializar cuando se carga la página
        window.addEventListener('load', () => {
            synthesizer = new KlattSynthesizer();
        });

        // Funciones de control
        async function toggleSound() {
            if (!synthesizer.isPlaying) {
                await synthesizer.startSound();
            } else {
                synthesizer.stopSound();
            }
        }

        function stopSound() {
            synthesizer.stopSound();
        }

        function setVowel(vowel) {
            synthesizer.setVowelPreset(vowel);
        }

        function resetToDefaults(tab) {
            synthesizer.resetToDefaults(tab);
        }

        async function downloadWAV() {
            await synthesizer.downloadWAV();
        }

        // Redimensionamiento de canvas
        window.addEventListener('resize', () => {
            if (synthesizer) {
                synthesizer.drawSpectrum();
            }
        });
                
